<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 
    =========================================================
    Empire Dashboard • Preview-Only Build (FULL) + Calendar Views v3.2.0
    ---------------------------------------------------------
    • Calendar view toggle for all brands
    • Content scheduling and event planning  
    • Multi-brand calendar overlay option
    • Drag and drop between pipeline and calendar
    =========================================================
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empire Dashboard — Preview</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fff;
            --bg-mute: #f6f7fb;
            --border: #e3e5ee;
            --text: #1a1a1a;
            --text-m: #6e6e82;
            --accent: #8245ff;
            --shadow: 0 2px 6px rgba(0,0,0,.06);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        body {
            background: var(--bg);
            color: var(--text);
            line-height: 1.55;
            padding-bottom: 4rem;
        }
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.9rem;
            margin: 1.4rem 0 1rem;
        }
        h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            margin: 1rem 0 .4rem;
        }
        .wrap {
            max-width: 1280px;
            margin: auto;
            padding: 0 1.4rem;
        }
        /* nav */
        .nav {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            margin-bottom: 1.6rem;
        }
        .nav-btn {
            padding: .45rem .9rem;
            border: 1px solid var(--border);
            border-radius: 7px;
            font-size: .84rem;
            font-weight: 600;
            background: var(--bg-mute);
            cursor: pointer;
            transition: .2s;
        }
        .nav-btn.active,
        .nav-btn:hover {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        /* totals */
        .totals {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2.1rem;
        }
        .tot {
            flex: 1 1 160px;
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 10px;
            text-align: center;
            padding: 1rem;
            box-shadow: var(--shadow);
        }
        .tot-val {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: var(--accent);
            font-weight: 700;
        }
        .tot-lbl {
            font-size: .7rem;
            color: var(--text-m);
            text-transform: uppercase;
            letter-spacing: .4px;
        }
        /* overview */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.4rem;
        }
        .card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.1rem;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform .25s, box-shadow .25s;
        }
        .card:hover {
            transform: translateY(-4px);
        }
        .badge {
            display: inline-block;
            padding: .15rem .55rem;
            border-radius: 999px;
            font-size: .66rem;
            font-weight: 600;
            color: #fff;
            text-transform: lowercase;
        }
        .badge.active { background: #4ade80; }
        .badge.launching { background: #f97316; }
        .badge.planning { background: #60a5fa; }
        .brand {
            font-family: 'Playfair Display', serif;
            font-size: 1.23rem;
            margin: .2rem 0 .4rem;
        }
        .desc {
            font-size: .82rem;
            color: var(--text-m);
            margin-bottom: 1rem;
        }
        .metrics {
            display: flex;
            gap: .6rem;
            flex-wrap: wrap;
        }
        .mbox {
            flex: 1 1 90px;
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: .6rem;
            text-align: center;
        }
        .mval {
            font-weight: 700;
            color: var(--accent);
        }
        .mlbl {
            font-size: .68rem;
            color: var(--text-m);
            text-transform: uppercase;
        }
        /* view */
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .p-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: .5rem;
        }
        .p-controls {
            display: flex;
            gap: .5rem;
            align-items: center;
        }
        /* view toggle */
        .view-toggle {
            display: flex;
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .toggle-btn {
            padding: .4rem .8rem;
            border: none;
            background: transparent;
            font-size: .78rem;
            font-weight: 600;
            cursor: pointer;
            transition: .2s;
        }
        .toggle-btn.active {
            background: var(--accent);
            color: #fff;
        }
        /* multi-brand toggle */
        .multi-brand {
            display: flex;
            align-items: center;
            gap: .5rem;
            font-size: .78rem;
        }
        .multi-brand input[type="checkbox"] {
            margin: 0;
        }
        /* pipeline */
        .pipeline {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            margin-bottom: 2rem;
        }
        .col {
            min-width: 220px;
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 9px;
            padding: 1rem;
            flex: 1 0 220px;
            display: flex;
            flex-direction: column;
        }
        .c-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: .88rem;
            margin-bottom: .65rem;
        }
        .c-count {
            background: var(--accent);
            color: #fff;
            font-size: .65rem;
            border-radius: 6px;
            padding: .15rem .45rem;
        }
        .list {
            flex: 1 1 auto;
            min-height: 100px;
        }
        .item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 7px;
            padding: .45rem;
            font-size: .8rem;
            margin-bottom: .5rem;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .item-date {
            font-size: .68rem;
            color: var(--text-m);
            margin-left: .4rem;
        }
        .item.ready { border-left: 3px solid #4ade80; }
        .item.published { border-left: 3px solid #6b7280; opacity: .7; }
        .item.inProgress { border: 2px dashed var(--accent); }
        .item.planning { opacity: .6; }
        .item.upcoming { border-left: 3px solid #f97316; }
        .item.marketing { animation: pulse 2s infinite; }
        .item.completed { opacity: .5; text-decoration: line-through; }
        /* calendar */
        .calendar {
            display: none;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        .calendar.active {
            display: block;
        }
        .cal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .cal-nav {
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: .3rem .8rem;
            cursor: pointer;
            font-size: .9rem;
            transition: .2s;
            user-select: none;
        }
        .cal-nav:hover {
            background: var(--accent);
            color: #fff;
        }
        .cal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 600;
        }
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: 9px;
            overflow: hidden;
        }
        .cal-day-header {
            background: var(--bg-mute);
            padding: .8rem .5rem;
            text-align: center;
            font-size: .75rem;
            font-weight: 600;
            color: var(--text-m);
            text-transform: uppercase;
        }
        .cal-day-header.weekend {
            background: #f8f9ff;
        }
        .cal-date {
            background: var(--bg);
            min-height: 85px;
            padding: .4rem;
            position: relative;
            cursor: pointer;
            transition: .2s;
            border-bottom: 1px solid transparent;
        }
        .cal-date:hover {
            background: var(--bg-mute);
        }
        .cal-date.today {
            border-bottom: 2px solid var(--accent);
            background: #fafbff;
        }
        .cal-date.other-month {
            opacity: .3;
        }
        .cal-date.weekend {
            background: #fafbff;
        }
        .cal-date.weekend.other-month {
            background: #f8f9fa;
            opacity: .2;
        }
        .cal-date-num {
            font-size: .8rem;
            font-weight: 600;
            margin-bottom: .3rem;
        }
        .cal-items {
            display: flex;
            flex-direction: column;
            gap: .2rem;
        }
        .cal-item {
            font-size: .65rem;
            padding: .15rem .3rem;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .cal-item.ready {
            background: #4ade80;
        }
        .cal-item.ready::before {
            content: '📅 ';
            font-size: .6rem;
        }
        .cal-item.published {
            background: #6b7280;
            opacity: .8;
        }
        .cal-item.published::before {
            content: '✓ ';
            font-size: .6rem;
        }
        .cal-item.inProgress {
            background: transparent;
            border: 1px dashed var(--accent);
            color: var(--accent);
        }
        .cal-item.planning {
            background: rgba(96, 165, 250, .4);
            color: var(--text);
        }
        .cal-item.upcoming {
            background: #f97316;
        }
        .cal-item.marketing {
            background: #8b5cf6;
            animation: pulse 2s infinite;
        }
        .cal-item.completed {
            background: #6b7280;
            opacity: .5;
            text-decoration: line-through;
        }
        .cal-more {
            font-size: .6rem;
            color: var(--text-m);
            padding: .1rem .3rem;
            cursor: pointer;
        }
        .cal-more:hover {
            color: var(--accent);
        }
        /* content type icons */
        .content-icon {
            font-size: .7rem;
            margin-right: .2rem;
        }
        .type-video::before { content: '🎥 '; }
        .type-article::before { content: '✏️ '; }
        .type-newsletter::before { content: '📧 '; }
        .type-social::before { content: '📱 '; }
        .type-event::before { content: '📅 '; }
        /* tooltip */
        .tooltip {
            position: absolute;
            background: #1a1a1a;
            color: #fff;
            padding: .4rem .6rem;
            border-radius: 6px;
            font-size: .7rem;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity .2s;
            white-space: nowrap;
        }
        .tooltip.show {
            opacity: 1;
        }
        /* animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .add {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: .4rem .8rem;
            font-size: .78rem;
            font-weight: 600;
            cursor: pointer;
        }
        /* brand metrics grid */
        .brand-metrics {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }
        .brand-mbox {
            flex: 1 1 140px;
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 10px;
            text-align: center;
            padding: .7rem;
            box-shadow: var(--shadow);
        }
        .brand-mval {
            font-family: 'Playfair Display', serif;
            font-size: 1.15rem;
            color: var(--accent);
            font-weight: 700;
        }
        .brand-mlabel {
            font-size: .7rem;
            color: var(--text-m);
            text-transform: uppercase;
            letter-spacing: .4px;
        }
        /* responsive */
        @media (max-width: 768px) {
            .cal-date {
                min-height: 70px;
                padding: .3rem;
            }
            .cal-date-num {
                font-size: .7rem;
            }
            .cal-item {
                font-size: .6rem;
                padding: .1rem .2rem;
            }
            .p-head {
                flex-direction: column;
                align-items: stretch;
            }
            .p-controls {
                justify-content: space-between;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
    <div class="wrap">
        <h1>Empire Dashboard</h1>
        <div id="nav" class="nav"></div>
        <div id="totals" class="totals"></div>
        <div id="overview" class="grid"></div>
        <div id="views"></div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        'use strict';
        
        // ---------- helpers ----------
        function el(tag, cls, txt) {
            var e = document.createElement(tag);
            if (cls) { e.className = cls; }
            if (txt !== undefined) { e.textContent = txt; }
            return e;
        }
        
        function qs(sel, scope) {
            return (scope || document).querySelector(sel);
        }
        
        function qsa(sel, scope) {
            return Array.prototype.slice.call((scope || document).querySelectorAll(sel));
        }
        
        function fmt(n) {
            if (typeof n === 'string') { return n; }
            return (n >= 1e6 ? Math.round(n/1e5)/10 + 'M' : n >= 1e3 ? Math.round(n/1e2)/10 + 'K' : n);
        }
        
        function todayISO() {
            return new Date().toISOString().slice(0, 10);
        }
        
        // ---------- demo data ----------
        var BRANDS = [
            {id: 'knf', name: 'KNF', desc: 'Personal brand & cultural criticism', status: 'active', accent: '#e63cff', reach: 125000, revenue: 15000, engage: 4.5},
            {id: 'fh', name: 'For Harriet', desc: 'Black feminist publication', status: 'active', accent: '#652399', reach: 250000, revenue: 22000, engage: 5.1},
            {id: 'mtih', name: 'Making Things is Hard', desc: 'Tech & business for creatives', status: 'active', accent: '#006aff', reach: 45000, revenue: 8000, engage: 6.2},
            {id: 'sss', name: 'The Shallow Side', desc: 'Fashion & beauty commentary', status: 'launching', accent: '#ff5880', reach: 500, revenue: 0, engage: 0},
            {id: 'tok', name: 'Taste of Kimberly', desc: 'Personal style newsletter', status: 'planning', accent: '#9e2fff', reach: 0, revenue: 0, engage: 0},
            {id: 'bwitw', name: 'Black Women in the Wild', desc: 'Community events & connections', status: 'active', accent: '#ffb600', events: 6, community: 250},
            {id: 'indigo', name: 'Indigo Hour', desc: 'Intellectual salon series', status: 'planning', accent: '#532dff', events: 0, community: 0}
        ];
        
        var PIPELINES = {
            knf: {
                ideas: ['Award season analysis', 'TikTok trends', 'Celebrity interviews'],
                inProgress: ['Video: Nostalgia', 'Article: Fashion Politics'],
                ready: ['Instagram posts', 'Tweet threads'],
                published: ['Video: Representation', 'Newsletter: March']
            },
            fh: {
                ideas: ['Feature: Black Tech', 'Interview: Scholar'],
                inProgress: ['Video essay'],
                ready: [],
                published: ['Op-ed']
            },
            mtih: {
                ideas: ['Tool review video', 'Essay: Creative Burnout'],
                inProgress: [],
                ready: ['Podcast episode'],
                published: ['Newsletter: April']
            },
            sss: {
                ideas: ['Shade range critique'],
                inProgress: [],
                ready: [],
                published: []
            },
            tok: {
                ideas: ['Lookbook concept'],
                inProgress: [],
                ready: [],
                published: []
            },
            bwitw: {
                planning: ['Spring Hike (2024-04-15)'],
                upcoming: ['June Mixer (2024-06-20)'],
                marketing: ['IG Carousel'],
                completed: ['January Brunch (2024-01-15)']
            },
            indigo: {
                planning: ['Select panelists'],
                upcoming: [],
                marketing: [],
                completed: []
            }
        };
        
        // Calendar data and view states
        var CALENDAR_DATA = {};
        var VIEW_STATES = {}; // tracks pipeline vs calendar view for each brand
        var CURRENT_MONTH = {}; // tracks current month for each brand calendar
        var MULTI_BRAND_VIEW = false;
        var EVENT_BRANDS = ['bwitw', 'indigo'];
        var EDIT_STAGES = ['ideas', 'inProgress', 'ready', 'published'];
        var EVENT_STAGES = ['planning', 'upcoming', 'marketing', 'completed'];
        var brandOrder = BRANDS.map(function(b) { return b.id; });
        
        // Initialize calendar data and view states
        BRANDS.forEach(function(b) {
            CALENDAR_DATA[b.id] = {};
            VIEW_STATES[b.id] = 'pipeline';
            CURRENT_MONTH[b.id] = {
                year: new Date().getFullYear(),
                month: new Date().getMonth()
            };
        });
        
        // ---------- date utilities ----------
        function getMonthDates(year, month) {
            var firstDay = new Date(year, month, 1);
            var lastDay = new Date(year, month + 1, 0);
            var startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            var dates = [];
            var current = new Date(startDate);
            
            for (var i = 0; i < 42; i++) {
                dates.push({
                    date: new Date(current),
                    dateStr: current.toISOString().slice(0, 10),
                    day: current.getDate(),
                    isCurrentMonth: current.getMonth() === month,
                    isToday: current.toDateString() === new Date().toDateString(),
                    isWeekend: current.getDay() === 0 || current.getDay() === 6
                });
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }
        
        function getMonthName(month) {
            var names = ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
            return names[month];
        }
        
        // ---------- calendar data management ----------
        function addToCalendar(brandId, dateStr, item, stage) {
            if (!CALENDAR_DATA[brandId][dateStr]) {
                CALENDAR_DATA[brandId][dateStr] = [];
            }
            
            var calItem = {
                title: typeof item === 'string' ? item : item.title || item,
                stage: stage || 'ready',
                type: getContentType(typeof item === 'string' ? item : item.title || item),
                id: Date.now() + Math.random()
            };
            
            CALENDAR_DATA[brandId][dateStr].push(calItem);
        }
        
        function removeFromCalendar(brandId, dateStr, itemId) {
            if (CALENDAR_DATA[brandId][dateStr]) {
                CALENDAR_DATA[brandId][dateStr] = CALENDAR_DATA[brandId][dateStr].filter(function(item) {
                    return item.id !== itemId;
                });
                if (CALENDAR_DATA[brandId][dateStr].length === 0) {
                    delete CALENDAR_DATA[brandId][dateStr];
                }
            }
        }
        
        function getContentType(title) {
            var lower = title.toLowerCase();
            if (lower.includes('video')) return 'video';
            if (lower.includes('article') || lower.includes('essay')) return 'article';
            if (lower.includes('newsletter')) return 'newsletter';
            if (lower.includes('post') || lower.includes('tweet') || lower.includes('instagram')) return 'social';
            return 'article';
        }
        
        // ---------- build UI ----------
        function buildNav() {
            var nav = qs('#nav');
            if (!nav) return;
            nav.innerHTML = '';
            
            ['overview'].concat(brandOrder).forEach(function(id) {
                var b = (id === 'overview') ? {name: 'Overview', id: 'overview'} : 
                        BRANDS.filter(function(br) { return br.id === id; })[0];
                if (!b) return;
                
                var btn = el('button', 'nav-btn', b.name);
                btn.dataset.id = id;
                btn.onclick = function() { show(id); };
                nav.appendChild(btn);
            });
        }
        
        function buildOverview() {
            var grid = qs('#overview');
            if (!grid) return;
            grid.innerHTML = '';
            
            BRANDS.forEach(function(b) {
                var c = el('div', 'card');
                c.onclick = function() { show(b.id); };
                c.style.borderColor = b.accent;
                c.appendChild(el('span', 'badge ' + b.status, b.status));
                c.appendChild(el('div', 'brand', b.name));
                c.appendChild(el('div', 'desc', b.desc));
                
                var mrow = el('div', 'metrics');
                if (EVENT_BRANDS.indexOf(b.id) === -1) {
                    mrow.appendChild(metricBox(fmt(b.reach), 'Reach'));
                    mrow.appendChild(metricBox('$' + fmt(b.revenue), 'Revenue'));
                    mrow.appendChild(metricBox(b.engage + '%', 'Engage'));
                } else {
                    mrow.appendChild(metricBox(b.events, 'Events'));
                    mrow.appendChild(metricBox(b.community, 'Community'));
                }
                c.appendChild(mrow);
                grid.appendChild(c);
            });
        }
        
        function metricBox(val, lbl) {
            var box = el('div', 'mbox');
            box.appendChild(el('div', 'mval', val));
            box.appendChild(el('div', 'mlbl', lbl));
            return box;
        }
        
        function buildViews() {
            var wrap = qs('#views');
            if (!wrap) return;
            wrap.innerHTML = '';
            
            BRANDS.forEach(function(b) {
                var v = el('div', 'view');
                v.id = 'view-' + b.id;
                
                // header with controls
                var head = el('div', 'p-head');
                head.appendChild(el('h2', null, b.name));
                
                var controls = el('div', 'p-controls');
                
                // view toggle
                var toggle = el('div', 'view-toggle');
                var pipeBtn = el('button', 'toggle-btn', 'Pipeline');
                var calBtn = el('button', 'toggle-btn', 'Calendar');
                
                pipeBtn.onclick = function() { toggleView(b.id, 'pipeline'); };
                calBtn.onclick = function() { toggleView(b.id, 'calendar'); };
                
                toggle.appendChild(pipeBtn);
                toggle.appendChild(calBtn);
                controls.appendChild(toggle);
                
                // multi-brand option (only show in calendar view)
                var multiCheck = el('div', 'multi-brand');
                multiCheck.style.display = 'none';
                var checkbox = el('input');
                checkbox.type = 'checkbox';
                checkbox.onchange = function() {
                    MULTI_BRAND_VIEW = this.checked;
                    if (VIEW_STATES[b.id] === 'calendar') buildCalendar(b.id);
                };
                multiCheck.appendChild(checkbox);
                multiCheck.appendChild(el('span', null, 'Multi-brand'));
                controls.appendChild(multiCheck);
                
                // add button
                var addBtn = el('button', 'add', (EVENT_BRANDS.indexOf(b.id) === -1) ? '+ Add Content' : '+ Add Event');
                addBtn.style.background = b.accent;
                addBtn.onclick = function() { addItem(b.id); };
                controls.appendChild(addBtn);
                
                head.appendChild(controls);
                v.appendChild(head);
                
                // brand metrics
                var bm = el('div', 'brand-metrics');
                if (EVENT_BRANDS.indexOf(b.id) === -1) {
                    bm.appendChild(brandBox(fmt(b.reach), 'Reach'));
                    bm.appendChild(brandBox('$' + fmt(b.revenue), 'Revenue'));
                    bm.appendChild(brandBox(b.engage + '%', 'Engage'));
                } else {
                    bm.appendChild(brandBox(b.events, 'Events'));
                    bm.appendChild(brandBox(b.community, 'Community'));
                }
                v.appendChild(bm);
                
                // pipeline view
                var pipelineView = el('div', 'pipeline-view');
                pipelineView.id = 'pipeline-' + b.id;
                buildPipeline(b, pipelineView);
                v.appendChild(pipelineView);
                
                // calendar view
                var calendarView = el('div', 'calendar');
                calendarView.id = 'calendar-' + b.id;
                v.appendChild(calendarView);
                
                wrap.appendChild(v);
            });
        }
        
        function buildPipeline(brand, container) {
            var pipe = el('div', 'pipeline');
            var stages = (EVENT_BRANDS.indexOf(brand.id) === -1) ? EDIT_STAGES : EVENT_STAGES;
            
            stages.forEach(function(stage) {
                var col = el('div', 'col');
                col.dataset.brand = brand.id;
                col.dataset.stage = stage;
                
                var chead = el('div', 'c-head');
                chead.appendChild(el('span', null, stage.replace(/([A-Z])/g, ' $1').replace(/^./, function(ch) { return ch.toUpperCase(); })));
                var count = el('span', 'c-count', '0');
                chead.appendChild(count);
                col.appendChild(chead);
                
                var list = el('div', 'list');
                (PIPELINES[brand.id][stage] || []).forEach(function(it) {
                    list.appendChild(itemElem(it, stage));
                });
                col.appendChild(list);
                pipe.appendChild(col);
                
                // Enable drag and drop
                if (typeof Sortable !== 'undefined') {
                    new Sortable(list, {
                        group: brand.id,
                        animation: 150,
                        onEnd: function(evt) {
                            updateAll();
                        }
                    });
                }
            });
            
            container.appendChild(pipe);
        }
        
        function buildCalendar(brandId) {
            var brand = BRANDS.find(function(b) { return b.id === brandId; });
            if (!brand) return;
            
            var calContainer = qs('#calendar-' + brandId);
            if (!calContainer) return;
            calContainer.innerHTML = '';
            
            var currentMonth = CURRENT_MONTH[brandId];
            
            // Calendar header
            var header = el('div', 'cal-header');
            
            var prevBtn = el('div', 'cal-nav', '‹');
            prevBtn.onclick = function() {
                if (currentMonth.month === 0) {
                    currentMonth.month = 11;
                    currentMonth.year--;
                } else {
                    currentMonth.month--;
                }
                buildCalendar(brandId);
            };
            
            var title = el('div', 'cal-title', getMonthName(currentMonth.month) + ' ' + currentMonth.year);
            
            var nextBtn = el('div', 'cal-nav', '›');
            nextBtn.onclick = function() {
                if (currentMonth.month === 11) {
                    currentMonth.month = 0;
                    currentMonth.year++;
                } else {
                    currentMonth.month++;
                }
                buildCalendar(brandId);
            };
            
            header.appendChild(prevBtn);
            header.appendChild(title);
            header.appendChild(nextBtn);
            calContainer.appendChild(header);
            
            // Calendar grid
            var grid = el('div', 'cal-grid');
            
            // Day headers
            var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(function(day, i) {
                var dayHeader = el('div', 'cal-day-header' + (i === 0 || i === 6 ? ' weekend' : ''), day);
                grid.appendChild(dayHeader);
            });
            
            // Date cells
            var dates = getMonthDates(currentMonth.year, currentMonth.month);
            
            dates.forEach(function(dateInfo) {
                var dateCell = el('div', 'cal-date');
                if (!dateInfo.isCurrentMonth) dateCell.classList.add('other-month');
                if (dateInfo.isToday) dateCell.classList.add('today');
                if (dateInfo.isWeekend) dateCell.classList.add('weekend');
                
                var dateNum = el('div', 'cal-date-num', dateInfo.day);
                dateCell.appendChild(dateNum);
                
                var itemsContainer = el('div', 'cal-items');
                
                // Add items for this date
                var itemsForDate = [];
                
                if (MULTI_BRAND_VIEW) {
                    // Show items from all brands
                    BRANDS.forEach(function(b) {
                        if (CALENDAR_DATA[b.id] && CALENDAR_DATA[b.id][dateInfo.dateStr]) {
                            CALENDAR_DATA[b.id][dateInfo.dateStr].forEach(function(item) {
                                itemsForDate.push({
                                    ...item,
                                    brandColor: b.accent,
                                    brandId: b.id
                                });
                            });
                        }
                    });
                } else {
                    // Show items only for current brand
                    if (CALENDAR_DATA[brandId] && CALENDAR_DATA[brandId][dateInfo.dateStr]) {
                        itemsForDate = CALENDAR_DATA[brandId][dateInfo.dateStr].map(function(item) {
                            return {
                                ...item,
                                brandColor: brand.accent,
                                brandId: brandId
                            };
                        });
                    }
                }
                
                // Display items (max 3, then show "more")
                var maxVisible = 3;
                itemsForDate.slice(0, maxVisible).forEach(function(item) {
                    var itemEl = el('div', 'cal-item ' + item.stage + ' type-' + item.type, item.title);
                    itemEl.style.background = MULTI_BRAND_VIEW ? item.brandColor : brand.accent;
                    itemEl.dataset.itemId = item.id;
                    itemEl.dataset.brandId = item.brandId;
                    itemEl.dataset.date = dateInfo.dateStr;
                    
                    // Add tooltip
                    itemEl.title = item.title + ' (' + item.stage + ')';
                    
                    itemsContainer.appendChild(itemEl);
                });
                
                if (itemsForDate.length > maxVisible) {
                    var moreEl = el('div', 'cal-more', '+' + (itemsForDate.length - maxVisible) + ' more');
                    moreEl.onclick = function() {
                        alert('Items for ' + dateInfo.dateStr + ':\n\n' + 
                              itemsForDate.map(function(item) {
                                  return '• ' + item.title + ' (' + item.stage + ')';
                              }).join('\n'));
                    };
                    itemsContainer.appendChild(moreEl);
                }
                
                dateCell.appendChild(itemsContainer);
                
                // Make date clickable for adding items
                dateCell.onclick = function(e) {
                    if (e.target === dateCell || e.target === dateNum || e.target === itemsContainer) {
                        addItemToDate(brandId, dateInfo.dateStr);
                    }
                };
                
                grid.appendChild(dateCell);
            });
            
            calContainer.appendChild(grid);
        }
        
        function brandBox(val, lbl) {
            var b = el('div', 'brand-mbox');
            b.appendChild(el('div', 'brand-mval', val));
            b.appendChild(el('div', 'brand-mlabel', lbl));
            return b;
        }
        
        function itemElem(txt, stage) {
            var it = el('div', 'item ' + (stage || ''));
            var span = el('span', null, txt);
            it.appendChild(span);
            it.dataset.title = txt;
            it.dataset.stage = stage;
            return it;
        }
        
        // ---------- interactions ----------
        function show(id) {
            ['overview'].concat(brandOrder).forEach(function(bid) {
                var navBtn = qs('.nav-btn[data-id="' + bid + '"]');
                if (navBtn) {
                    navBtn.classList[bid === id ? 'add' : 'remove']('active');
                }
            });
            
            var overview = qs('#overview');
            if (overview) {
                overview.style.display = (id === 'overview') ? 'grid' : 'none';
            }
            
            var views = qs('#views');
            if (views) {
                Array.prototype.forEach.call(views.children, function(v) {
                    v.classList.remove('active');
                });
            }
            
            if (id !== 'overview') {
                var view = qs('#view-' + id);
                if (view) {
                    view.classList.add('active');
                    
                    // Update toggle buttons
                    var pipeBtn = view.querySelector('.toggle-btn:first-child');
                    var calBtn = view.querySelector('.toggle-btn:last-child');
                    var multiBrand = view.querySelector('.multi-brand');
                    var pipelineView = qs('#pipeline-' + id);
                    var calendarView = qs('#calendar-' + id);
                    
                    if (VIEW_STATES[id] === 'pipeline') {
                        if (pipeBtn) pipeBtn.classList.add('active');
                        if (calBtn) calBtn.classList.remove('active');
                        if (pipelineView) pipelineView.style.display = 'flex';
                        if (calendarView) calendarView.classList.remove('active');
                        if (multiBrand) multiBrand.style.display = 'none';
                    } else {
                        if (pipeBtn) pipeBtn.classList.remove('active');
                        if (calBtn) calBtn.classList.add('active');
                        if (pipelineView) pipelineView.style.display = 'none';
                        if (calendarView) calendarView.classList.add('active');
                        if (multiBrand) multiBrand.style.display = 'flex';
                        buildCalendar(id);
                    }
                }
            }
            
            updateAll();
        }
        
        function toggleView(brandId, viewType) {
            VIEW_STATES[brandId] = viewType;
            show(brandId);
        }
        
        function addItem(bid) {
            var txt = prompt('Enter title');
            if (!txt) { return; }
            
            var stage = (EVENT_BRANDS.indexOf(bid) === -1) ? 'ideas' : 'planning';
            
            if (VIEW_STATES[bid] === 'calendar') {
                // Add directly to today on calendar
                var today = todayISO();
                addToCalendar(bid, today, txt, stage);
                buildCalendar(bid);
            } else {
                // Add to pipeline
                if (!PIPELINES[bid][stage]) { PIPELINES[bid][stage] = []; }
                PIPELINES[bid][stage].push(txt);
                
                // Rebuild pipeline view
                var brand = BRANDS.find(function(b) { return b.id === bid; });
                var pipelineView = qs('#pipeline-' + bid);
                if (brand && pipelineView) {
                    pipelineView.innerHTML = '';
                    buildPipeline(brand, pipelineView);
                }
            }
            
            updateAll();
        }
        
        function addItemToDate(brandId, dateStr) {
            var title = prompt('Enter title for ' + dateStr + ':');
            if (title) {
                addToCalendar(brandId, dateStr, title, 'planning');
                buildCalendar(brandId);
                updateAll();
            }
        }
        
        function updateCounts() {
            var cols = qsa('.col');
            cols.forEach(function(col) {
                var cnt = col.querySelectorAll('.item').length;
                var badge = col.querySelector('.c-count');
                if (badge) { badge.textContent = cnt; }
            });
        }
        
        function updateTotals() {
            var totalItems = 0, totalReach = 0, totalRevenue = 0, totalEvents = 0;
            
            BRANDS.forEach(function(b) {
                var stages = (EVENT_BRANDS.indexOf(b.id) === -1) ? EDIT_STAGES : EVENT_STAGES;
                stages.forEach(function(s) {
                    var col = qs('.col[data-brand="' + b.id + '"][data-stage="' + s + '"]');
                    if (col) {
                        totalItems += col.querySelectorAll('.item').length;
                    }
                });
                
                // Add calendar items to total
                if (CALENDAR_DATA[b.id]) {
                    Object.keys(CALENDAR_DATA[b.id]).forEach(function(date) {
                        totalItems += CALENDAR_DATA[b.id][date].length;
                    });
                }
                
                if (EVENT_BRANDS.indexOf(b.id) === -1) {
                    totalReach += b.reach;
                    totalRevenue += b.revenue;
                } else {
                    totalEvents += b.events;
                }
            });
            
            var totals = qs('#totals');
            if (totals) {
                totals.innerHTML = '';
                totals.appendChild(totalBox(totalItems, 'Pipeline Items'));
                totals.appendChild(totalBox(fmt(totalReach), 'Total Reach'));
                totals.appendChild(totalBox('$' + fmt(totalRevenue), 'Total Revenue'));
                totals.appendChild(totalBox(totalEvents, 'Total Events'));
            }
        }
        
        function totalBox(val, lbl) {
            var t = el('div', 'tot');
            t.appendChild(el('div', 'tot-val', val));
            t.appendChild(el('div', 'tot-lbl', lbl));
            return t;
        }
        
        function updateAll() {
            updateCounts();
            updateTotals();
        }
        
        // ---------- initialize ----------
        buildNav();
        buildOverview();
        buildViews();
        show('overview');
    });
    </script>
</body>
</html>
