<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Your Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDTd41vsTlzjKeGu7Eq91IM3Q-8v88h-ng",
    authDomain: "productivity-tracker-knf13.firebaseapp.com",
    projectId: "productivity-tracker-knf13",
    storageBucket: "productivity-tracker-knf13.firebasestorage.app",
    messagingSenderId: "76203539357",
    appId: "1:76203539357:web:7d474a6a57c631b80d96"
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>
    <!-- 
    =========================================================
    Empire Dashboard • Enhanced Edition v5.0.0
    ---------------------------------------------------------
    NEW FEATURES:
    • Dark mode with system preference detection
    • Advanced filtering and search
    • Drag & drop file uploads anywhere
    • Rich text editor for content
    • Automated workflows
    • Content performance predictions
    • Collaborative features
    • Export to multiple formats
    • Keyboard shortcuts guide
    • Improved mobile experience
    • Real-time notifications
    • AI content suggestions
    =========================================================
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empire Dashboard — Enhanced v5</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fff;
            --bg-mute: #f6f7fb;
            --border: #e3e5ee;
            --text: #1a1a1a;
            --text-m: #6e6e82;
            --accent: #8245ff;
            --shadow: 0 2px 6px rgba(0,0,0,.06);
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            --glass: rgba(255,255,255,0.8);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Dark mode variables */
        [data-theme="dark"] {
            --bg: #0a0a0a;
            --bg-mute: #1a1a1a;
            --border: #2a2a2a;
            --text: #f0f0f0;
            --text-m: #a0a0a0;
            --shadow: 0 2px 12px rgba(0,0,0,.3);
            --glass: rgba(0,0,0,0.8);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: var(--bg);
            color: var(--text);
            line-height: 1.55;
            padding-bottom: 4rem;
            transition: var(--transition);
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-mute);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-m);
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.9rem;
            margin: 1.4rem 0 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            margin: 1rem 0 .4rem;
        }
        
        .wrap {
            max-width: 1280px;
            margin: auto;
            padding: 0 1.4rem;
        }
        
        /* Header controls */
        .header-controls {
            display: flex;
            gap: .5rem;
            margin-left: auto;
        }
        
        .theme-toggle {
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: .5rem;
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
        }
        
        .theme-toggle:hover {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        
        /* Enhanced nav */
        .nav {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            margin-bottom: 1.6rem;
            position: sticky;
            top: 0;
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            z-index: 100;
            margin-left: -1.4rem;
            margin-right: -1.4rem;
            padding-left: 1.4rem;
            padding-right: 1.4rem;
        }
        
        .nav-btn {
            padding: .45rem .9rem;
            border: 1px solid var(--border);
            border-radius: 7px;
            font-size: .84rem;
            font-weight: 600;
            background: var(--bg-mute);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .nav-btn.active,
        .nav-btn:hover {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(130, 69, 255, 0.3);
        }
        
        .nav-btn.has-notification::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Enhanced totals with animations */
        .totals {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2.1rem;
        }
        
        .tot {
            flex: 1 1 160px;
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 10px;
            text-align: center;
            padding: 1rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }
        
        .tot:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,.1);
        }
        
        .tot-val {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: var(--accent);
            font-weight: 700;
            transition: var(--transition);
        }
        
        .tot:hover .tot-val {
            transform: scale(1.05);
        }
        
        .tot-lbl {
            font-size: .7rem;
            color: var(--text-m);
            text-transform: uppercase;
            letter-spacing: .4px;
        }
        
        /* Enhanced grid with hover effects */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.4rem;
        }
        
        .card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.1rem;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s;
        }
        
        .card:hover::before {
            transform: translateX(0);
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,.1);
        }
        
        .badge {
            display: inline-block;
            padding: .15rem .55rem;
            border-radius: 999px;
            font-size: .66rem;
            font-weight: 600;
            color: #fff;
            text-transform: lowercase;
        }
        
        .badge.active { background: #4ade80; }
        .badge.launching { background: #f97316; }
        .badge.planning { background: #60a5fa; }
        
        .brand {
            font-family: 'Playfair Display', serif;
            font-size: 1.23rem;
            margin: .2rem 0 .4rem;
        }
        
        .desc {
            font-size: .82rem;
            color: var(--text-m);
            margin-bottom: 1rem;
        }
        
        .metrics {
            display: flex;
            gap: .6rem;
            flex-wrap: wrap;
        }
        
        .mbox {
            flex: 1 1 90px;
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: .6rem;
            text-align: center;
        }
        
        .mval {
            font-weight: 700;
            color: var(--accent);
        }
        
        .mlbl {
            font-size: .68rem;
            color: var(--text-m);
            text-transform: uppercase;
        }
        
        /* Enhanced view system */
        .view {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        
        .view.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .p-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: .5rem;
        }
        
        .p-controls {
            display: flex;
            gap: .5rem;
            align-items: center;
        }
        
        /* View toggle with smooth animation */
        .view-toggle {
            display: flex;
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .view-toggle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background: var(--accent);
            transition: transform 0.3s;
            z-index: 0;
        }
        
        .view-toggle.calendar::before {
            transform: translateX(100%);
        }
        
        .toggle-btn {
            padding: .4rem .8rem;
            border: none;
            background: transparent;
            font-size: .78rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            z-index: 1;
        }
        
        .toggle-btn.active {
            color: #fff;
        }
        
        /* Enhanced pipeline with smooth drag animations */
        .pipeline {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            margin-bottom: 2rem;
            padding-bottom: .5rem;
        }
        
        .col {
            min-width: 220px;
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 9px;
            padding: 1rem;
            flex: 1 0 220px;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }
        
        .col.drag-over {
            background: var(--bg);
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(130, 69, 255, 0.2);
        }
        
        .c-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: .88rem;
            margin-bottom: .65rem;
        }
        
        .c-count {
            background: var(--accent);
            color: #fff;
            font-size: .65rem;
            border-radius: 6px;
            padding: .15rem .45rem;
            animation: scaleIn 0.3s ease-out;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); }
            to { transform: scale(1); }
        }
        
        .list {
            flex: 1 1 auto;
            min-height: 100px;
        }
        
        .item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 7px;
            padding: .45rem;
            font-size: .8rem;
            margin-bottom: .5rem;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            transition: var(--transition);
        }
        
        .item:active {
            cursor: grabbing;
        }
        
        .item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        
        .item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }
        
        .item.deleting {
            opacity: 0;
            transform: scale(0.9) translateX(100%);
        }
        
        .item-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        
        .item-title {
            flex: 1;
            cursor: pointer;
        }
        
        .item-title:hover {
            text-decoration: underline;
        }
        
        .item-date {
            font-size: .68rem;
            color: var(--text-m);
            margin-left: .4rem;
        }
        
        .item-actions {
            display: flex;
            gap: .3rem;
            opacity: 0;
            transition: opacity .2s;
        }
        
        .item:hover .item-actions {
            opacity: 1;
        }
        
        .item-action {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: .9rem;
            padding: .2rem;
            color: var(--text-m);
            transition: color .2s;
        }
        
        .item-action.edit:hover {
            color: var(--accent);
        }
        
        .item-action.delete:hover {
            color: var(--danger);
        }
        
        /* Stage-specific styles */
        .item.ready { border-left: 3px solid #4ade80; }
        .item.published { border-left: 3px solid #6b7280; opacity: .7; }
        .item.inProgress { border: 2px dashed var(--accent); }
        .item.planning { opacity: .6; }
        .item.upcoming { border-left: 3px solid #f97316; }
        .item.marketing { animation: pulse 2s infinite; }
        .item.completed { opacity: .5; text-decoration: line-through; }
        
        /* Priority badges */
        .priority-badge {
            font-size: .6rem;
            padding: .1rem .3rem;
            border-radius: 3px;
            font-weight: 600;
        }
        
        .priority-high {
            background: var(--danger);
            color: #fff;
            animation: pulse 2s infinite;
        }
        
        .priority-medium {
            background: var(--warning);
            color: #fff;
        }
        
        .priority-low {
            background: var(--bg-mute);
            color: var(--text-m);
        }
        
        /* Inline edit with better UX */
        .item-edit-inline {
            display: flex;
            gap: .3rem;
            flex: 1;
        }
        
        .item-edit-input {
            flex: 1;
            padding: .2rem .4rem;
            border: 1px solid var(--accent);
            border-radius: 4px;
            font-size: .8rem;
            font-family: inherit;
            background: var(--bg);
            color: var(--text);
        }
        
        .item-edit-btn {
            padding: .2rem .4rem;
            border: none;
            border-radius: 4px;
            font-size: .7rem;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .item-edit-save {
            background: var(--success);
            color: #fff;
        }
        
        .item-edit-save:hover {
            transform: scale(1.05);
        }
        
        .item-edit-cancel {
            background: var(--bg-mute);
            color: var(--text);
        }
        
        /* Enhanced edit panel with glassmorphism */
        .edit-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100%;
            background: var(--glass);
            backdrop-filter: blur(20px);
            box-shadow: -2px 0 20px rgba(0,0,0,.2);
            transition: right .3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .edit-panel.open {
            right: 0;
        }
        
        .edit-panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .edit-panel-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .edit-panel-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-m);
            transition: var(--transition);
        }
        
        .edit-panel-close:hover {
            color: var(--text);
            transform: rotate(90deg);
        }
        
        .edit-panel-body {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        .form-label {
            display: block;
            font-size: .8rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: .4rem;
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: .5rem .7rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: .85rem;
            font-family: inherit;
            transition: border-color .2s;
            background: var(--bg);
            color: var(--text);
        }
        
        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(130, 69, 255, 0.1);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* Tags with better interaction */
        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: .4rem;
            padding: .4rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            min-height: 38px;
            background: var(--bg);
        }
        
        .tag {
            background: var(--accent);
            color: #fff;
            padding: .2rem .5rem;
            border-radius: 4px;
            font-size: .75rem;
            display: flex;
            align-items: center;
            gap: .3rem;
            animation: scaleIn 0.2s ease-out;
        }
        
        .tag-remove {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .tag-remove:hover {
            transform: scale(1.2);
        }
        
        .form-actions {
            display: flex;
            gap: .5rem;
            margin-top: 1.5rem;
        }
        
        .btn {
            padding: .5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: .85rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .btn:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: var(--accent);
            color: #fff;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(130, 69, 255, 0.3);
        }
        
        .btn-secondary {
            background: var(--bg-mute);
            color: var(--text);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        /* Enhanced calendar with better interactions */
        .calendar {
            display: none;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .calendar.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        .cal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .cal-nav {
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: .3rem .8rem;
            cursor: pointer;
            font-size: .9rem;
            transition: var(--transition);
            user-select: none;
        }
        
        .cal-nav:hover {
            background: var(--accent);
            color: #fff;
            transform: scale(1.05);
        }
        
        .cal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: 9px;
            overflow: hidden;
        }
        
        .cal-day-header {
            background: var(--bg-mute);
            padding: .8rem .5rem;
            text-align: center;
            font-size: .75rem;
            font-weight: 600;
            color: var(--text-m);
            text-transform: uppercase;
        }
        
        .cal-day-header.weekend {
            background: var(--bg);
            color: var(--accent);
        }
        
        .cal-date {
            background: var(--bg);
            min-height: 85px;
            padding: .4rem;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid transparent;
        }
        
        .cal-date:hover {
            background: var(--bg-mute);
            z-index: 1;
            box-shadow: 0 2px 8px rgba(0,0,0,.1);
        }
        
        .cal-date.today {
            border-bottom: 2px solid var(--accent);
            background: linear-gradient(to bottom, var(--bg), rgba(130, 69, 255, 0.05));
        }
        
        .cal-date.other-month {
            opacity: .3;
        }
        
        .cal-date.weekend {
            background: var(--bg-mute);
        }
        
        .cal-date-num {
            font-size: .8rem;
            font-weight: 600;
            margin-bottom: .3rem;
        }
        
        .cal-items {
            display: flex;
            flex-direction: column;
            gap: .2rem;
        }
        
        .cal-item {
            font-size: .65rem;
            padding: .15rem .3rem;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: var(--transition);
        }
        
        .cal-item:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,.2);
        }
        
        .cal-item.deleting {
            opacity: 0;
            transform: scale(0.9) translateX(20px);
        }
        
        .cal-item:hover .cal-item-delete {
            display: block;
        }
        
        .cal-item-delete {
            display: none;
            position: absolute;
            right: 2px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,.3);
            color: #fff;
            border: none;
            padding: 0 .2rem;
            cursor: pointer;
            font-size: .8rem;
            border-radius: 3px;
            transition: var(--transition);
        }
        
        .cal-item-delete:hover {
            background: rgba(0,0,0,.5);
        }
        
        /* Calendar item states */
        .cal-item.ready {
            background: #4ade80;
        }
        
        .cal-item.published {
            background: #6b7280;
            opacity: .8;
        }
        
        .cal-item.inProgress {
            background: transparent;
            border: 1px dashed var(--accent);
            color: var(--accent);
        }
        
        .cal-item.planning {
            background: rgba(96, 165, 250, .4);
            color: var(--text);
        }
        
        .cal-item.upcoming {
            background: #f97316;
        }
        
        .cal-item.marketing {
            background: #8b5cf6;
            animation: pulse 2s infinite;
        }
        
        .cal-item.completed {
            background: #6b7280;
            opacity: .5;
            text-decoration: line-through;
        }
        
        /* Content type icons */
        .content-icon {
            font-size: .7rem;
            margin-right: .2rem;
        }
        
        /* Floating tooltip */
        .tooltip {
            position: fixed;
            background: var(--bg);
            color: var(--text);
            padding: .8rem 1rem;
            border-radius: 8px;
            font-size: .8rem;
            z-index: 2000;
            pointer-events: none;
            opacity: 0;
            transition: opacity .2s;
            box-shadow: 0 4px 12px rgba(0,0,0,.2);
            border: 1px solid var(--border);
            max-width: 250px;
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: .8; transform: scale(0.95); }
        }
        
        .add {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: .4rem .8rem;
            font-size: .78rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(130, 69, 255, 0.3);
        }
        
        /* Brand metrics grid */
        .brand-metrics {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }
        
        .brand-mbox {
            flex: 1 1 140px;
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 10px;
            text-align: center;
            padding: .7rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .brand-mbox:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }
        
        .brand-mval {
            font-family: 'Playfair Display', serif;
            font-size: 1.15rem;
            color: var(--accent);
            font-weight: 700;
        }
        
        .brand-mlabel {
            font-size: .7rem;
            color: var(--text-m);
            text-transform: uppercase;
            letter-spacing: .4px;
        }
        
        /* Advanced filter bar */
        .filter-bar {
            display: flex;
            gap: .5rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-mute);
            border-radius: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-input {
            flex: 1;
            min-width: 200px;
            padding: .5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: .85rem;
            background: var(--bg);
            color: var(--text);
        }
        
        .filter-select {
            padding: .5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: .85rem;
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
        }
        
        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: .3rem;
            padding: .3rem .6rem;
            background: var(--accent);
            color: #fff;
            border-radius: 16px;
            font-size: .75rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .filter-chip:hover {
            transform: scale(1.05);
        }
        
        /* AI suggestions panel */
        .ai-suggestions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 300px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 8px 24px rgba(0,0,0,.2);
            transform: translateY(calc(100% + 2rem));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
        }
        
        .ai-suggestions.show {
            transform: translateY(0);
        }
        
        .ai-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: .8rem;
        }
        
        .ai-title {
            font-weight: 600;
            font-size: .9rem;
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        
        .ai-suggestion {
            padding: .8rem;
            background: var(--bg-mute);
            border-radius: 8px;
            margin-bottom: .5rem;
            cursor: pointer;
            transition: var(--transition);
            font-size: .85rem;
        }
        
        .ai-suggestion:hover {
            background: var(--accent);
            color: #fff;
            transform: translateX(4px);
        }
        
        /* Keyboard shortcuts modal */
        .shortcuts-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,.3);
            z-index: 2000;
        }
        
        .shortcuts-modal.show {
            display: block;
            animation: scaleIn 0.3s ease-out;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: .6rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .shortcut-keys {
            display: flex;
            gap: .3rem;
        }
        
        .key {
            background: var(--bg-mute);
            border: 1px solid var(--border);
            padding: .2rem .5rem;
            border-radius: 4px;
            font-size: .8rem;
            font-family: monospace;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        
        /* Drag and drop overlay */
        .drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(130, 69, 255, 0.1);
            backdrop-filter: blur(2px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .drop-overlay.active {
            display: flex;
        }
        
        .drop-message {
            background: var(--bg);
            padding: 2rem 3rem;
            border-radius: 12px;
            border: 2px dashed var(--accent);
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent);
            box-shadow: 0 8px 24px rgba(0,0,0,.2);
        }
        
        /* Rich text editor */
        .rich-editor {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg);
        }
        
        .editor-toolbar {
            display: flex;
            gap: .5rem;
            padding: .5rem;
            background: var(--bg-mute);
            border-bottom: 1px solid var(--border);
        }
        
        .editor-btn {
            background: transparent;
            border: none;
            padding: .4rem;
            cursor: pointer;
            font-size: .9rem;
            border-radius: 4px;
            transition: var(--transition);
        }
        
        .editor-btn:hover {
            background: var(--bg);
        }
        
        .editor-btn.active {
            background: var(--accent);
            color: #fff;
        }
        
        .editor-content {
            padding: 1rem;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .editor-content:focus {
            outline: none;
        }
        
        /* Notification system */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            box-shadow: 0 8px 24px rgba(0,0,0,.2);
            transform: translateX(calc(100% + 2rem));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 3000;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left: 3px solid var(--success);
        }
        
        .notification.error {
            border-left: 3px solid var(--danger);
        }
        
        .notification.info {
            border-left: 3px solid var(--info);
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: .3rem;
        }
        
        .notification-message {
            font-size: .85rem;
            color: var(--text-m);
        }
        
        /* Export modal */
        .export-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,.3);
            z-index: 2000;
            width: 90%;
            max-width: 400px;
        }
        
        .export-modal.show {
            display: block;
            animation: scaleIn 0.3s ease-out;
        }
        
        .export-options {
            display: flex;
            flex-direction: column;
            gap: .8rem;
            margin: 1.5rem 0;
        }
        
        .export-option {
            display: flex;
            align-items: center;
            gap: .8rem;
            padding: 1rem;
            background: var(--bg-mute);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .export-option:hover {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        
        .export-icon {
            font-size: 1.5rem;
        }
        
        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Performance monitor (dev mode) */
        .perf-monitor {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background: rgba(0,0,0,.8);
            color: #fff;
            padding: .5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: .7rem;
            z-index: 9999;
            display: none;
        }
        
        .perf-monitor.show {
            display: block;
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .wrap {
                padding: 0 1rem;
            }
            
            .nav {
                padding: .8rem 1rem;
                margin-left: -1rem;
                margin-right: -1rem;
            }
            
            .cal-date {
                min-height: 70px;
                padding: .3rem;
            }
            
            .cal-date-num {
                font-size: .7rem;
            }
            
            .cal-item {
                font-size: .6rem;
                padding: .1rem .2rem;
            }
            
            .p-head {
                flex-direction: column;
                align-items: stretch;
            }
            
            .p-controls {
                justify-content: space-between;
            }
            
            .edit-panel {
                width: 100%;
                right: -100%;
            }
            
            .ai-suggestions {
                width: calc(100% - 4rem);
                right: 2rem;
                left: 2rem;
            }
            
            .pipeline {
                scroll-snap-type: x mandatory;
            }
            
            .col {
                scroll-snap-align: start;
            }
        }
        
        /* Print styles */
        @media print {
            body {
                background: #fff;
                color: #000;
            }
            
            .nav, .header-controls, .filter-bar, .ai-suggestions {
                display: none !important;
            }
            
            .card, .col, .cal-date {
                break-inside: avoid;
            }
        }
        
        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Focus styles */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        /* Skip to content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent);
            color: #fff;
            padding: .5rem 1rem;
            text-decoration: none;
            border-radius: 0 0 8px 0;
        }
        
        .skip-link:focus {
            top: 0;
        }
        
        /* Save notification toast */
        .save-toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 3000;
        }
        
        .save-toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Template selector improvements */
        .template-selector {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            z-index: 1001;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,.2);
        }
        
        .template-selector.show {
            display: block;
            animation: scaleIn 0.3s ease-out;
        }
        
        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }
        
        .template-option {
            padding: 1.5rem 1rem;
            background: var(--bg-mute);
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .template-option:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }
        
        .template-icon {
            font-size: 2rem;
            margin-bottom: .5rem;
        }
        
        .template-name {
            font-size: .85rem;
            font-weight: 600;
        }
        
        /* Quick actions bar enhancements */
        .quick-actions {
            display: flex;
            gap: .5rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-mute);
            border-radius: 10px;
            align-items: center;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
        }
        
        .quick-action-btn {
            padding: .5rem .8rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: .8rem;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: .3rem;
            scroll-snap-align: start;
        }
        
        .quick-action-btn:hover {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(130, 69, 255, 0.3);
        }
        
        .quick-action-icon {
            font-size: 1rem;
        }
        
        /* Progress tracker enhancements */
        .progress-section {
            background: var(--bg-mute);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: .8rem;
        }
        
        .progress-bar {
            height: 10px;
            background: var(--border);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #a370ff);
            transition: width .5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-text {
            font-size: .75rem;
            color: var(--text-m);
            margin-top: .5rem;
            display: flex;
            justify-content: space-between;
        }
        
        /* Analytics Dashboard Improvements */
        .analytics-view {
            display: none;
            padding: 1.5rem 0;
        }
        
        .analytics-view.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .date-range-selector {
            display: flex;
            gap: .5rem;
            align-items: center;
        }
        
        .date-range-btn {
            padding: .4rem .8rem;
            border: 1px solid var(--border);
            background: var(--bg);
            border-radius: 6px;
            font-size: .8rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .date-range-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .analytics-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,.1);
        }
        
        .analytics-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .analytics-card-title {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .analytics-metric {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: .5rem;
        }
        
        .analytics-trend {
            font-size: .8rem;
            color: var(--text-m);
        }
        
        .trend-up {
            color: var(--success);
        }
        
        .trend-down {
            color: var(--danger);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        
        /* Event & Content Modal Improvements */
        .event-modal-overlay,
        .content-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            animation: fadeIn 0.3s ease-out;
        }
        
        .event-modal,
        .content-modal {
            background: var(--bg);
            border-radius: 20px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }
        
        /* Quick Search Improvements */
        .quick-search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 10vh;
            opacity: 0;
            animation: fadeIn 0.2s forwards;
        }
        
        .quick-search-modal {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            animation: slideDown 0.2s ease-out;
        }
        
        .quick-search-input {
            width: 100%;
            padding: 1.2rem 1.5rem;
            border: none;
            border-bottom: 1px solid var(--border);
            font-size: 1.1rem;
            font-family: inherit;
            outline: none;
            background: transparent;
            color: var(--text);
        }
        
        .quick-search-results {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .search-result {
            display: flex;
            align-items: center;
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }
        
        .search-result:hover,
        .search-result.selected {
            background: var(--bg-mute);
        }
        
        /* Workflow automation panel */
        .workflow-panel {
            background: var(--bg-mute);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .workflow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .workflow-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: .8rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: .5rem;
            transition: var(--transition);
        }
        
        .workflow-item:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }
        
        .workflow-icon {
            font-size: 1.2rem;
        }
        
        .workflow-info {
            flex: 1;
        }
        
        .workflow-title {
            font-weight: 600;
            font-size: .9rem;
            margin-bottom: .2rem;
        }
        
        .workflow-desc {
            font-size: .75rem;
            color: var(--text-m);
        }
        
        .workflow-toggle {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .workflow-toggle.active {
            background: var(--accent);
        }
        
        .workflow-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .workflow-toggle.active::after {
            transform: translateX(24px);
        }
        
        /* Collaboration features */
        .collab-indicator {
            display: flex;
            align-items: center;
            gap: .3rem;
            margin-left: auto;
            font-size: .75rem;
            color: var(--text-m);
        }
        
        .collab-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .65rem;
            font-weight: 600;
            border: 2px solid var(--bg);
            margin-left: -8px;
        }
        
        .collab-avatar:first-child {
            margin-left: 0;
        }
        
        /* Performance optimization placeholders */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-mute) 25%, var(--border) 50%, var(--bg-mute) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Error states */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        
        /* Empty states */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-m);
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: .5;
        }
        
        .empty-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: .5rem;
            color: var(--text);
        }
        
        .empty-desc {
            font-size: .9rem;
            margin-bottom: 1.5rem;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
    <a href="#main" class="skip-link">Skip to content</a>
    
    <div class="wrap">
        <h1>
            Empire Dashboard
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">🌙</button>
                <button class="theme-toggle" onclick="showShortcuts()" title="Keyboard shortcuts">⌨️</button>
                <button class="theme-toggle" onclick="togglePerformanceMonitor()" title="Performance monitor">📊</button>
            </div>
        </h1>
        
        <nav id="nav" class="nav" role="navigation"></nav>
        
        <main id="main">
            <div id="totals" class="totals"></div>
            <div id="overview" class="grid"></div>
            <div id="views"></div>
        </main>
    </div>
    
    <!-- Drop overlay for file uploads -->
    <div class="drop-overlay" id="dropOverlay">
        <div class="drop-message">📁 Drop files to upload</div>
    </div>
    
    <!-- AI Suggestions Panel -->
    <div class="ai-suggestions" id="aiSuggestions">
        <div class="ai-header">
            <div class="ai-title">
                <span>🤖</span>
                AI Suggestions
            </div>
            <button onclick="toggleAISuggestions()" style="background: none; border: none; cursor: pointer;">×</button>
        </div>
        <div id="aiSuggestionsContent"></div>
    </div>
    
    <!-- Performance Monitor -->
    <div class="perf-monitor" id="perfMonitor">
        <div>FPS: <span id="fps">60</span></div>
        <div>Items: <span id="itemCount">0</span></div>
        <div>Memory: <span id="memUsage">0</span>MB</div>
    </div>
    
    <!-- Keyboard Shortcuts Modal -->
    <div class="shortcuts-modal" id="shortcutsModal">
        <h3>Keyboard Shortcuts</h3>
        <div class="shortcut-item">
            <span>Quick Search</span>
            <div class="shortcut-keys">
                <span class="key">⌘</span>
                <span class="key">K</span>
            </div>
        </div>
        <div class="shortcut-item">
            <span>New Content</span>
            <div class="shortcut-keys">
                <span class="key">⌘</span>
                <span class="key">N</span>
            </div>
        </div>
        <div class="shortcut-item">
            <span>Toggle Theme</span>
            <div class="shortcut-keys">
                <span class="key">⌘</span>
                <span class="key">D</span>
            </div>
        </div>
        <div class="shortcut-item">
            <span>Export Data</span>
            <div class="shortcut-keys">
                <span class="key">⌘</span>
                <span class="key">E</span>
            </div>
        </div>
        <div class="shortcut-item">
            <span>Focus Search</span>
            <div class="shortcut-keys">
                <span class="key">/</span>
            </div>
        </div>
        <div class="shortcut-item">
            <span>Navigate Brands</span>
            <div class="shortcut-keys">
                <span class="key">1-7</span>
            </div>
        </div>
        <button class="btn btn-primary" onclick="closeShortcuts()" style="margin-top: 1rem; width: 100%;">Close</button>
    </div>
    
    <!-- Export Modal -->
    <div class="export-modal" id="exportModal">
        <h3>Export Your Data</h3>
        <p style="color: var(--text-m); margin-bottom: 1rem;">Choose your export format:</p>
        <div class="export-options">
            <div class="export-option" onclick="exportData('json')">
                <span class="export-icon">📄</span>
                <div>
                    <div style="font-weight: 600;">JSON</div>
                    <div style="font-size: .8rem; color: var(--text-m);">Complete data backup</div>
                </div>
            </div>
            <div class="export-option" onclick="exportData('csv')">
                <span class="export-icon">📊</span>
                <div>
                    <div style="font-weight: 600;">CSV</div>
                    <div style="font-size: .8rem; color: var(--text-m);">For spreadsheets</div>
                </div>
            </div>
            <div class="export-option" onclick="exportData('pdf')">
                <span class="export-icon">📑</span>
                <div>
                    <div style="font-weight: 600;">PDF Report</div>
                    <div style="font-size: .8rem; color: var(--text-m);">Formatted summary</div>
                </div>
            </div>
        </div>
        <button class="btn btn-secondary" onclick="closeExportModal()" style="margin-top: 1rem; width: 100%;">Cancel</button>
    </div>
    
    <!-- Template Selector -->
    <div id="templateSelector" class="template-selector">
        <div class="template-header">
            <h3>Choose Content Type</h3>
            <button class="close-btn" onclick="closeTemplateSelector()">×</button>
        </div>
        <div class="template-grid">
            <div class="template-option" onclick="createFromTemplate('video')">
                <div class="template-icon">🎥</div>
                <div class="template-name">Video</div>
            </div>
            <div class="template-option" onclick="createFromTemplate('article')">
                <div class="template-icon">✏️</div>
                <div class="template-name">Article</div>
            </div>
            <div class="template-option" onclick="createFromTemplate('newsletter')">
                <div class="template-icon">📧</div>
                <div class="template-name">Newsletter</div>
            </div>
            <div class="template-option" onclick="createFromTemplate('social')">
                <div class="template-icon">📱</div>
                <div class="template-name">Social Post</div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Scheduler Modal -->
    <div id="bulkScheduler" class="template-selector">
        <div class="template-header">
            <h3>Bulk Scheduler</h3>
            <button class="close-btn" onclick="closeBulkScheduler()">×</button>
        </div>
        <div style="margin-bottom: 1rem">
            <label><strong>Schedule Type:</strong></label><br>
            <label><input type="radio" name="scheduleType" value="weekly" checked> Weekly</label>
            <label><input type="radio" name="scheduleType" value="monthly" style="margin-left: 1rem"> Monthly Pattern</label>
        </div>
        <div id="bulkOptions"></div>
        <div style="text-align: right; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="generateSchedule()">Create Schedule</button>
        </div>
    </div>
    
    <!-- Published Directory Modal -->
    <div id="publishedDirectory" class="template-selector">
        <div class="template-header">
            <h3>Published Content</h3>
            <button class="close-btn" onclick="closePublishedDirectory()">×</button>
        </div>
        <div style="margin-bottom: 1rem;">
            <label><strong>Filter by Brand:</strong></label>
            <select id="publishedBrandFilter">
                <option value="all">All Brands</option>
            </select>
        </div>
        <div>
            <input id="publishedSearchInput" class="form-input" type="text" placeholder="Search titles..." oninput="filterPublishedList()">
        </div>
        <ul id="publishedList" style="margin-top: 1.5rem; max-height: 60vh; overflow-y: auto; padding: 0; list-style: none;"></ul>
    </div>
    
    <!-- Edit Panel -->
    <div id="editPanel" class="edit-panel">
        <div class="edit-panel-header">
            <h3 class="edit-panel-title">Edit Item</h3>
            <button class="edit-panel-close" onclick="closeEditPanel()">×</button>
        </div>
        <div class="edit-panel-body">
            <form id="editForm">
                <div class="form-group">
                    <label class="form-label">Title <span class="help-tooltip" data-tooltip="Give your content a clear, descriptive title">?</span></label>
                    <input type="text" id="editTitle" class="form-input" placeholder="Enter title">
                </div>
                <div class="form-group">
                    <label class="form-label">Content Type</label>
                    <select id="editType" class="form-select">
                        <option value="video">🎥 Video</option>
                        <option value="article">✏️ Article</option>
                        <option value="newsletter">📧 Newsletter</option>
                        <option value="social">📱 Social Post</option>
                        <option value="podcast">🎙️ Podcast</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Scheduled Date</label>
                    <input type="date" id="editDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="editPriority" class="form-select">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Estimated Time (hours)</label>
                    <input type="number" id="editEstimatedTime" class="form-input" placeholder="2" min="0.5" step="0.5">
                </div>
                <div class="form-group">
                    <label class="form-label">Tags <span class="help-tooltip" data-tooltip="Add tags to organize and find content easier">?</span></label>
                    <div id="editTags" class="tags-input"></div>
                    <input type="text" id="editTagInput" class="form-input" placeholder="Add tag and press Enter" style="margin-top: .5rem;">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <div class="rich-editor">
                        <div class="editor-toolbar">
                            <button type="button" class="editor-btn" onclick="formatText('bold')" title="Bold">𝐁</button>
                            <button type="button" class="editor-btn" onclick="formatText('italic')" title="Italic">𝐼</button>
                            <button type="button" class="editor-btn" onclick="formatText('underline')" title="Underline">U̲</button>
                            <button type="button" class="editor-btn" onclick="formatText('insertUnorderedList')" title="Bullet List">•</button>
                            <button type="button" class="editor-btn" onclick="formatText('insertOrderedList')" title="Numbered List">1.</button>
                        </div>
                        <div id="editNotes" class="editor-content" contenteditable="true" placeholder="Add notes..."></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="saveEditPanel()">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditPanel()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        'use strict';
        
        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeToggle();
        
        // ---------- helpers ----------
        function el(tag, cls, txt) {
            var e = document.createElement(tag);
            if (cls) { e.className = cls; }
            if (txt !== undefined) { e.textContent = txt; }
            return e;
        }
        
        function qs(sel, scope) {
            return (scope || document).querySelector(sel);
        }
        
        function qsa(sel, scope) {
            return Array.prototype.slice.call((scope || document).querySelectorAll(sel));
        }
        
        function fmt(n) {
            if (typeof n === 'string') { return n; }
            return (n >= 1e6 ? Math.round(n/1e5)/10 + 'M' : n >= 1e3 ? Math.round(n/1e2)/10 + 'K' : n);
        }
        
        function todayISO() {
            return new Date().toISOString().slice(0, 10);
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Notification helper
        function showNotification(title, message, type = 'info') {
            const notification = el('div', 'notification ' + type);
            notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // ---------- demo data ----------
        var BRANDS = [
            {id: 'knf', name: 'KNF', desc: 'Personal brand & cultural criticism', status: 'active', accent: '#9973ff', reach: 270000, revenue: 15000, engage: 4.5},
            {id: 'fh', name: 'For Harriet', desc: 'Black feminist publication', status: 'active', accent: '#8b1ce8', reach: 250000, revenue: 22000, engage: 5.1},
            {id: 'mtih', name: 'Making Things is Hard', desc: 'Tech & business for creatives', status: 'active', accent: '#006aff', reach: 45000, revenue: 8000, engage: 6.2},
            {id: 'sss', name: 'The Shallow Side', desc: 'Fashion & beauty commentary', status: 'launching', accent: '#ff5880', reach: 500, revenue: 0, engage: 0},
            {id: 'tok', name: 'Taste of Kimberly', desc: 'Personal style newsletter', status: 'planning', accent: '#9e2fff', reach: 0, revenue: 0, engage: 0},
            {id: 'bwitw', name: 'Black Women in the Wild', desc: 'Community events & connections', status: 'active', accent: '#ffb600', events: 6, community: 250},
            {id: 'indigo', name: 'Indigo Hour', desc: 'Intellectual salon series', status: 'planning', accent: '#532dff', events: 0, community: 0}
        ];
        
        // Convert pipeline data to object structure
        function createItem(title, stage, extra) {
            return {
                id: generateId(),
                title: title,
                type: extra?.type || getContentType(title),
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                stage: stage,
                scheduledDate: extra?.scheduledDate || '',
                tags: extra?.tags || [],
                priority: extra?.priority || 'medium',
                notes: extra?.notes || '',
                estimatedTime: extra?.estimatedTime || 2,
                actualTime: extra?.actualTime || 0,
                progress: extra?.progress || 0,
                metrics: extra?.metrics || {views: 0, engagement: 0, revenue: 0},
                collaborators: extra?.collaborators || []
            };
        }
        
        var PIPELINES = {
            knf: {
                ideas: [
                    createItem('Award season analysis', 'ideas', {tags: ['culture', 'awards']}),
                    createItem('TikTok trends', 'ideas', {tags: ['social', 'trends'], priority: 'high'}),
                    createItem('Celebrity interviews', 'ideas', {tags: ['interview', 'celebrity']})
                ],
                inProgress: [
                    createItem('Video: Nostalgia', 'inProgress', {type: 'video', tags: ['video', 'culture'], priority: 'high', progress: 45}),
                    createItem('Article: Fashion Politics', 'inProgress', {type: 'article', tags: ['article', 'fashion'], progress: 70})
                ],
                ready: [
                    createItem('Instagram posts', 'ready', {type: 'social', tags: ['social'], scheduledDate: '2024-04-01'}),
                    createItem('Tweet threads', 'ready', {type: 'social', tags: ['social'], scheduledDate: '2024-04-02'})
                ],
                published: [
                    createItem('Video: Representation', 'published', {type: 'video', tags: ['video'], metrics: {views: 15000, engagement: 8.5}}),
                    createItem('Newsletter: March', 'published', {type: 'newsletter', tags: ['newsletter'], metrics: {views: 5000, engagement: 12}})
                ]
            },
            fh: {
                ideas: [
                    createItem('Feature: Black Tech', 'ideas', {tags: ['tech', 'feature']}),
                    createItem('Interview: Scholar', 'ideas', {tags: ['interview', 'academic']})
                ],
                inProgress: [
                    createItem('Video essay', 'inProgress', {type: 'video', tags: ['video', 'essay'], priority: 'high', progress: 30})
                ],
                ready: [],
                published: [
                    createItem('Op-ed', 'published', {type: 'article', tags: ['article'], metrics: {views: 8000}})
                ]
            },
            mtih: {
                ideas: [
                    createItem('Tool review video', 'ideas', {type: 'video', tags: ['video', 'review']}),
                    createItem('Essay: Creative Burnout', 'ideas', {type: 'article', tags: ['essay', 'mental-health'], priority: 'high'})
                ],
                inProgress: [],
                ready: [
                    createItem('Podcast episode', 'ready', {type: 'podcast', tags: ['podcast'], scheduledDate: '2024-04-15'})
                ],
                published: [
                    createItem('Newsletter: April', 'published', {type: 'newsletter', tags: ['newsletter']})
                ]
            },
            sss: {
                ideas: [createItem('Shade range critique', 'ideas', {tags: ['beauty', 'review']})],
                inProgress: [],
                ready: [],
                published: []
            },
            tok: {
                ideas: [createItem('Lookbook concept', 'ideas', {tags: ['fashion', 'lookbook']})],
                inProgress: [],
                ready: [],
                published: []
            },
            bwitw: {
                planning: [createItem('Spring Hike (2024-04-15)', 'planning', {scheduledDate: '2024-04-15', tags: ['outdoor', 'community']})],
                upcoming: [createItem('June Mixer (2024-06-20)', 'upcoming', {scheduledDate: '2024-06-20', tags: ['networking', 'social']})],
                marketing: [createItem('IG Carousel', 'marketing', {tags: ['social', 'promo']})],
                completed: [createItem('January Brunch (2024-01-15)', 'completed', {scheduledDate: '2024-01-15', tags: ['food', 'community']})]
            },
            indigo: {
                planning: [createItem('Select panelists', 'planning', {tags: ['preparation']})],
                upcoming: [],
                marketing: [],
                completed: []
            }
        };
        
        // Content templates
        var CONTENT_TEMPLATES = {
            video: {
                title: 'New Video: ',
                tags: ['video'],
                estimatedTime: 6,
                notes: '<strong>Hook:</strong><br><br><strong>Main Points:</strong><br>1. <br>2. <br>3. <br><br><strong>Call to Action:</strong>'
            },
            article: {
                title: 'Article: ',
                tags: ['article'],
                estimatedTime: 4,
                notes: '<strong>Outline:</strong><br><br><strong>Introduction:</strong><br><br><strong>Key Points:</strong><br><br><strong>Conclusion:</strong>'
            },
            newsletter: {
                title: 'Newsletter: ',
                tags: ['newsletter'],
                estimatedTime: 3,
                notes: '<strong>Subject Line:</strong><br><br><strong>Main Story:</strong><br><br><strong>Quick Updates:</strong><br><br><strong>Call to Action:</strong>'
            },
            social: {
                title: 'Social Post: ',
                tags: ['social'],
                estimatedTime: 1,
                notes: '<strong>Platform:</strong><br><br><strong>Caption:</strong><br><br><strong>Hashtags:</strong>'
            }
        };
        
        // Content ideas
        var CONTENT_IDEAS = [
            "Behind the scenes of your creative process",
            "Top 10 trends in your industry",
            "Interview with an inspiring person",
            "Day in the life vlog",
            "Beginner's guide to [topic]",
            "My biggest mistakes and what I learned",
            "Product review and honest opinion",
            "Q&A answering audience questions",
            "How-to tutorial for beginners",
            "Personal story about overcoming challenges",
            "Reaction to current events",
            "Collaboration with another creator",
            "Tips for productivity and time management",
            "Exploring a new place or experience",
            "Debunking common myths about [topic]"
        ];
        
        // AI suggestion topics
        var AI_SUGGESTIONS = [
            { title: "Trending: Fashion Week Coverage", desc: "Fashion weeks are happening - great time for commentary" },
            { title: "Evergreen: Beginner's Guide Series", desc: "Create foundational content for new followers" },
            { title: "Timely: End of Quarter Recap", desc: "Summarize your best content from the past 3 months" },
            { title: "Engaging: Behind the Scenes", desc: "Show your creative process to build connection" },
            { title: "Growth: Collaboration Opportunity", desc: "Partner with complementary creators" }
        ];
        
        // Workflow automation options
        var WORKFLOWS = [
            {
                id: 'auto-schedule',
                title: 'Auto-Schedule Ready Content',
                desc: 'Automatically schedule items when moved to Ready',
                icon: '📅',
                active: false
            },
            {
                id: 'reminder-notifications',
                title: 'Deadline Reminders',
                desc: 'Get notified 24 hours before scheduled dates',
                icon: '🔔',
                active: true
            },
            {
                id: 'performance-alerts',
                title: 'Performance Alerts',
                desc: 'Alert when content exceeds view targets',
                icon: '📈',
                active: true
            },
            {
                id: 'auto-archive',
                title: 'Auto-Archive Old Content',
                desc: 'Move published content older than 90 days',
                icon: '📦',
                active: false
            }
        ];
        
        // Global variables
        var CALENDAR_DATA = {};
        var VIEW_STATES = {};
        var CURRENT_MONTH = {};
        var MULTI_BRAND_VIEW = false;
        var EVENT_BRANDS = ['bwitw', 'indigo'];
        var EDIT_STAGES = ['ideas', 'inProgress', 'ready', 'published'];
        var EVENT_STAGES = ['planning', 'upcoming', 'marketing', 'completed'];
        var brandOrder = BRANDS.map(function(b) { return b.id; });
        var currentEditItem = null;
        var currentEditBrand = null;
        var sortableInstances = [];
        var currentStreak = 0;
        var lastPublishDate = null;
        var performanceInterval = null;
        
        // Initialize calendar data and view states
        BRANDS.forEach(function(b) {
            CALENDAR_DATA[b.id] = {};
            VIEW_STATES[b.id] = 'pipeline';
            CURRENT_MONTH[b.id] = {
                year: new Date().getFullYear(),
                month: new Date().getMonth()
            };
        });
        
        // ---------- Theme Management ----------
        function updateThemeToggle() {
            const btn = qs('.theme-toggle');
            const currentTheme = document.documentElement.getAttribute('data-theme');
            if (btn) {
                btn.textContent = currentTheme === 'dark' ? '☀️' : '🌙';
            }
        }
        
        window.toggleTheme = function() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeToggle();
            showNotification('Theme Changed', `Switched to ${newTheme} mode`, 'info');
        };
        
        // ---------- Performance Monitor ----------
        window.togglePerformanceMonitor = function() {
            const monitor = qs('#perfMonitor');
            monitor.classList.toggle('show');
            
            if (monitor.classList.contains('show')) {
                startPerformanceMonitoring();
            } else {
                stopPerformanceMonitoring();
            }
        };
        
        function startPerformanceMonitoring() {
            let lastTime = performance.now();
            let frames = 0;
            
            function updatePerformance() {
                frames++;
                const currentTime = performance.now();
                
                if (currentTime >= lastTime + 1000) {
                    qs('#fps').textContent = Math.round(frames * 1000 / (currentTime - lastTime));
                    frames = 0;
                    lastTime = currentTime;
                    
                    // Update item count
                    let itemCount = 0;
                    BRANDS.forEach(b => {
                        const stages = EVENT_BRANDS.includes(b.id) ? EVENT_STAGES : EDIT_STAGES;
                        stages.forEach(s => {
                            itemCount += (PIPELINES[b.id][s] || []).length;
                        });
                    });
                    qs('#itemCount').textContent = itemCount;
                    
                    // Update memory usage (if available)
                    if (performance.memory) {
                        qs('#memUsage').textContent = Math.round(performance.memory.usedJSHeapSize / 1048576);
                    }
                }
                
                performanceInterval = requestAnimationFrame(updatePerformance);
            }
            
            updatePerformance();
        }
        
        function stopPerformanceMonitoring() {
            if (performanceInterval) {
                cancelAnimationFrame(performanceInterval);
            }
        }
        
        // ---------- Keyboard Shortcuts ----------
        window.showShortcuts = function() {
            qs('#shortcutsModal').classList.add('show');
        };
        
        window.closeShortcuts = function() {
            qs('#shortcutsModal').classList.remove('show');
        };
        
        // Global keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Quick search: Cmd/Ctrl + K
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                QuickSearch.toggle();
            }
            
            // New content: Cmd/Ctrl + N
            if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
                e.preventDefault();
                const activeView = qsa('.view.active')[0];
                if (activeView) {
                    const brandId = activeView.id.replace('view-', '');
                    addItem(brandId);
                }
            }
            
            // Toggle theme: Cmd/Ctrl + D
            if ((e.metaKey || e.ctrlKey) && e.key === 'd') {
                e.preventDefault();
                toggleTheme();
            }
            
            // Export: Cmd/Ctrl + E
            if ((e.metaKey || e.ctrlKey) && e.key === 'e') {
                e.preventDefault();
                showExportModal();
            }
            
            // Focus search: /
            if (e.key === '/' && !e.metaKey && !e.ctrlKey) {
                const activeElement = document.activeElement;
                if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    const filterInput = qs('.filter-input');
                    if (filterInput) filterInput.focus();
                }
            }
            
            // Navigate brands: 1-7
            if (e.key >= '1' && e.key <= '7' && !e.metaKey && !e.ctrlKey) {
                const activeElement = document.activeElement;
                if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                    const index = parseInt(e.key) - 1;
                    if (index < BRANDS.length) {
                        show(BRANDS[index].id);
                    }
                }
            }
        });
        
        // ---------- Drag & Drop File Upload ----------
        let dragCounter = 0;
        
        document.addEventListener('dragenter', function(e) {
            e.preventDefault();
            dragCounter++;
            qs('#dropOverlay').classList.add('active');
        });
        
        document.addEventListener('dragleave', function(e) {
            e.preventDefault();
            dragCounter--;
            if (dragCounter === 0) {
                qs('#dropOverlay').classList.remove('active');
            }
        });
        
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('drop', function(e) {
            e.preventDefault();
            dragCounter = 0;
            qs('#dropOverlay').classList.remove('active');
            
            const files = e.dataTransfer.files;
            handleFileUpload(files);
        });
        
        function handleFileUpload(files) {
            Array.from(files).forEach(file => {
                if (file.type === 'application/json') {
                    // Import data
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            importData(data);
                            showNotification('Import Successful', 'Data imported from ' + file.name, 'success');
                        } catch (error) {
                            showNotification('Import Failed', 'Invalid file format', 'error');
                        }
                    };
                    reader.readAsText(file);
                } else if (file.type.startsWith('image/')) {
                    // Handle image uploads for content
                    showNotification('Image Upload', 'Image uploads coming soon!', 'info');
                }
            });
        }
        
        // ---------- Export functionality ----------
        window.showExportModal = function() {
            qs('#exportModal').classList.add('show');
        };
        
        window.closeExportModal = function() {
            qs('#exportModal').classList.remove('show');
        };
        
        window.exportData = function(format) {
            const data = {
                pipelines: PIPELINES,
                calendar: CALENDAR_DATA,
                exportDate: new Date().toISOString(),
                version: '5.0.0'
            };
            
            switch(format) {
                case 'json':
                    exportJSON(data);
                    break;
                case 'csv':
                    exportCSV(data);
                    break;
                case 'pdf':
                    showNotification('PDF Export', 'PDF export coming soon!', 'info');
                    break;
            }
            
            closeExportModal();
        };
        
        function exportJSON(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            downloadFile(blob, 'empire-dashboard-export-' + todayISO() + '.json');
        }
        
        function exportCSV(data) {
            let csv = 'Brand,Title,Type,Stage,Priority,Tags,Scheduled Date,Views,Revenue\n';
            
            BRANDS.forEach(brand => {
                const stages = EVENT_BRANDS.includes(brand.id) ? EVENT_STAGES : EDIT_STAGES;
                stages.forEach(stage => {
                    const items = PIPELINES[brand.id][stage] || [];
                    items.forEach(item => {
                        csv += `"${brand.name}","${item.title}","${item.type}","${stage}","${item.priority}","${item.tags.join(';')}","${item.scheduledDate || ''}","${item.metrics?.views || 0}","${item.metrics?.revenue || 0}"\n`;
                    });
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            downloadFile(blob, 'empire-dashboard-export-' + todayISO() + '.csv');
        }
        
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function importData(data) {
            if (data.pipelines) PIPELINES = data.pipelines;
            if (data.calendar) CALENDAR_DATA = data.calendar;
            updateAll();
            show('overview');
        }
        
        // ---------- AI Suggestions ----------
        window.toggleAISuggestions = function() {
            const panel = qs('#aiSuggestions');
            panel.classList.toggle('show');
            
            if (panel.classList.contains('show')) {
                generateAISuggestions();
            }
        };
        
        function generateAISuggestions() {
            const content = qs('#aiSuggestionsContent');
            content.innerHTML = '';
            
            // Randomly select 3 suggestions
            const selected = AI_SUGGESTIONS.sort(() => 0.5 - Math.random()).slice(0, 3);
            
            selected.forEach(suggestion => {
                const div = el('div', 'ai-suggestion');
                div.innerHTML = `<strong>${suggestion.title}</strong><br><small>${suggestion.desc}</small>`;
                div.onclick = function() {
                    createFromAISuggestion(suggestion);
                };
                content.appendChild(div);
            });
        }
        
        function createFromAISuggestion(suggestion) {
            const activeView = qsa('.view.active')[0];
            if (activeView) {
                const brandId = activeView.id.replace('view-', '');
                const newItem = createItem(suggestion.title, 'ideas', {
                    tags: ['ai-suggested'],
                    notes: suggestion.desc
                });
                
                if (!PIPELINES[brandId].ideas) PIPELINES[brandId].ideas = [];
                PIPELINES[brandId].ideas.push(newItem);
                
                refreshView(brandId);
                saveToFirebase();
                toggleAISuggestions();
                showNotification('Content Added', 'AI suggestion added to ideas', 'success');
            }
        }
        
        // Show AI suggestions periodically
        setInterval(() => {
            const hasIdeas = BRANDS.some(b => (PIPELINES[b.id].ideas || []).length === 0);
            if (hasIdeas) {
                generateAISuggestions();
                qs('#aiSuggestions').classList.add('show');
                setTimeout(() => {
                    qs('#aiSuggestions').classList.remove('show');
                }, 10000);
            }
        }, 300000); // Every 5 minutes
        
        // ---------- Rich Text Editor ----------
        window.formatText = function(command) {
            document.execCommand(command, false, null);
            qs('#editNotes').focus();
        };
        
        // ---------- Enhanced Save Notification ----------
        function showSaveNotification() {
            var toast = el('div', 'save-toast', '✓ Changes saved to cloud');
            document.body.appendChild(toast);
            setTimeout(function() { toast.classList.add('show'); }, 10);
            setTimeout(function() {
                toast.classList.remove('show');
                setTimeout(function() { toast.remove(); }, 300);
            }, 2000);
        }
        
        // ---------- Firebase sync functions with debouncing ----------
        const saveToFirebase = debounce(function() {
            // Save pipelines
            Object.keys(PIPELINES).forEach(function(brandId) {
                db.collection('empire-pipelines').doc(brandId).set({
                    data: PIPELINES[brandId],
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(function(error) {
                    console.error('Error saving pipeline for ' + brandId, error);
                    showNotification('Save Error', 'Failed to save ' + brandId, 'error');
                });
            });
            
            // Save calendar data
            Object.keys(CALENDAR_DATA).forEach(function(brandId) {
                db.collection('empire-calendar').doc(brandId).set({
                    data: CALENDAR_DATA[brandId],
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(function(error) {
                    console.error('Error saving calendar for ' + brandId, error);
                });
            });
            
            // Show notification once at the end
            showSaveNotification();
        }, 1000);

        function loadFromFirebase() {
            // Show loading state
            showNotification('Loading', 'Fetching your data...', 'info');
            
            // Load pipelines
            BRANDS.forEach(function(brand) {
                db.collection('empire-pipelines').doc(brand.id).get()
                    .then(function(doc) {
                        if (doc.exists) {
                            PIPELINES[brand.id] = doc.data().data || PIPELINES[brand.id];
                            updateAll();
                        }
                    })
                    .catch(function(error) {
                        console.error('Error loading pipeline for ' + brand.id, error);
                    });
            });
            
            // Load calendar data
            BRANDS.forEach(function(brand) {
                db.collection('empire-calendar').doc(brand.id).get()
                    .then(function(doc) {
                        if (doc.exists) {
                            CALENDAR_DATA[brand.id] = doc.data().data || {};
                        }
                    })
                    .catch(function(error) {
                        console.error('Error loading calendar for ' + brand.id, error);
                    });
            });
        }
        
        // ---------- date utilities ----------
        function getMonthDates(year, month) {
            var firstDay = new Date(year, month, 1);
            var lastDay = new Date(year, month + 1, 0);
            var startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            var dates = [];
            var current = new Date(startDate);
            
            for (var i = 0; i < 42; i++) {
                dates.push({
                    date: new Date(current),
                    dateStr: current.toISOString().slice(0, 10),
                    day: current.getDate(),
                    isCurrentMonth: current.getMonth() === month,
                    isToday: current.toDateString() === new Date().toDateString(),
                    isWeekend: current.getDay() === 0 || current.getDay() === 6
                });
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }
        
        function getMonthName(month) {
            var names = ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
            return names[month];
        }
        
        function addDays(dateStr, days) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + days);
            return date.toISOString().slice(0, 10);
        }
        
        // ---------- calendar data management ----------
        function addToCalendar(brandId, dateStr, item, stage) {
            if (!CALENDAR_DATA[brandId][dateStr]) {
                CALENDAR_DATA[brandId][dateStr] = [];
            }
            
            CALENDAR_DATA[brandId][dateStr].push(item);
        }
        
        function removeFromCalendar(brandId, dateStr, itemId) {
            if (CALENDAR_DATA[brandId][dateStr]) {
                CALENDAR_DATA[brandId][dateStr] = CALENDAR_DATA[brandId][dateStr].filter(function(item) {
                    return item.id !== itemId;
                });
                if (CALENDAR_DATA[brandId][dateStr].length === 0) {
                    delete CALENDAR_DATA[brandId][dateStr];
                }
            }
        }
        
        function getContentType(title) {
            var lower = title.toLowerCase();
            if (lower.includes('video')) return 'video';
            if (lower.includes('article') || lower.includes('essay')) return 'article';
            if (lower.includes('newsletter')) return 'newsletter';
            if (lower.includes('post') || lower.includes('tweet') || lower.includes('instagram')) return 'social';
            if (lower.includes('podcast')) return 'podcast';
            return 'article';
        }
        
        function getContentIcon(type) {
            var icons = {
                video: '🎥',
                article: '✏️',
                newsletter: '📧',
                social: '📱',
                podcast: '🎙️'
            };
            return icons[type] || '📄';
        }
        
        // ---------- item management ----------
        function deleteItem(brandId, itemId, stage) {
            if (confirm('Are you sure you want to delete this item?')) {
                // Find and remove from pipeline
                var stages = EVENT_BRANDS.indexOf(brandId) === -1 ? EDIT_STAGES : EVENT_STAGES;
                stages.forEach(function(s) {
                    if (PIPELINES[brandId][s]) {
                        PIPELINES[brandId][s] = PIPELINES[brandId][s].filter(function(item) {
                            return item.id !== itemId;
                        });
                    }
                });
                
                // Remove from calendar if exists
                Object.keys(CALENDAR_DATA[brandId]).forEach(function(date) {
                    removeFromCalendar(brandId, date, itemId);
                });
                
                // Refresh view
                if (VIEW_STATES[brandId] === 'calendar') {
                    buildCalendar(brandId);
                } else {
                    var brand = BRANDS.find(function(b) { return b.id === brandId; });
                    var pipelineView = qs('#pipeline-' + brandId);
                    if (brand && pipelineView) {
                        pipelineView.innerHTML = '';
                        buildPipeline(brand, pipelineView);
                    }
                }
                updateAll();
                saveToFirebase();
                showNotification('Item Deleted', 'Content removed successfully', 'success');
            }
        }
        
        function deleteCalendarItem(brandId, itemId, dateStr) {
            if (confirm('Are you sure you want to delete this item?')) {
                removeFromCalendar(brandId, dateStr, itemId);
                buildCalendar(brandId);
                updateAll();
                saveToFirebase();
            }
        }
        
        function startInlineEdit(itemEl, item, brandId) {
            var titleEl = itemEl.querySelector('.item-title');
            var currentTitle = item.title;
            
            var editContainer = el('div', 'item-edit-inline');
            var input = el('input', 'item-edit-input');
            input.type = 'text';
            input.value = currentTitle;
            
            var saveBtn = el('button', 'item-edit-btn item-edit-save', '✓');
            var cancelBtn = el('button', 'item-edit-btn item-edit-cancel', '×');
            
            saveBtn.onclick = function() {
                item.title = input.value;
                item.modified = new Date().toISOString();
                refreshView(brandId);
                saveToFirebase();
            };
            
            cancelBtn.onclick = function() {
                refreshView(brandId);
            };
            
            input.onkeydown = function(e) {
                if (e.key === 'Enter') saveBtn.click();
                if (e.key === 'Escape') cancelBtn.click();
            };
            
            editContainer.appendChild(input);
            editContainer.appendChild(saveBtn);
            editContainer.appendChild(cancelBtn);
            
            titleEl.replaceWith(editContainer);
            input.focus();
            input.select();
        }
        
        function refreshView(brandId) {
            if (VIEW_STATES[brandId] === 'calendar') {
                buildCalendar(brandId);
            } else {
                var brand = BRANDS.find(function(b) { return b.id === brandId; });
                var pipelineView = qs('#pipeline-' + brandId);
                if (brand && pipelineView) {
                    pipelineView.innerHTML = '';
                    buildPipeline(brand, pipelineView);
                    
                    // Refresh other components
                    var brandView = qs('#view-' + brandId);
                    if (brandView) {
                        qsa('.daily-summary-panel', brandView).forEach(p => p.remove());
                        const afterProgress = brandView.querySelector('.progress-section');
                        if (afterProgress) {
                            afterProgress.insertAdjacentElement('afterend', buildTodaySummary(brandId));
                        }
                    }
                }
            }
            updateAll();
        }
        
        // ---------- edit panel ----------
        window.openEditPanel = function(item, brandId) {
            currentEditItem = item;
            currentEditBrand = brandId;
            
            qs('#editTitle').value = item.title || '';
            qs('#editType').value = item.type || 'article';
            qs('#editDate').value = item.scheduledDate || '';
            qs('#editPriority').value = item.priority || 'medium';
            qs('#editEstimatedTime').value = item.estimatedTime || 2;
            
            // Load rich text notes
            const notesEl = qs('#editNotes');
            notesEl.innerHTML = item.notes || '';
            
            // Load tags
            var tagsContainer = qs('#editTags');
            tagsContainer.innerHTML = '';
            (item.tags || []).forEach(function(tag) {
                addTagToPanel(tag);
            });
            
            qs('#editPanel').classList.add('open');
        };
        
        window.closeEditPanel = function() {
            qs('#editPanel').classList.remove('open');
            currentEditItem = null;
            currentEditBrand = null;
        };
        
        window.saveEditPanel = function() {
            if (currentEditItem && currentEditBrand) {
                currentEditItem.title = qs('#editTitle').value;
                currentEditItem.type = qs('#editType').value;
                currentEditItem.scheduledDate = qs('#editDate').value;
                currentEditItem.priority = qs('#editPriority').value;
                currentEditItem.estimatedTime = parseFloat(qs('#editEstimatedTime').value) || 2;
                currentEditItem.notes = qs('#editNotes').innerHTML;
                currentEditItem.modified = new Date().toISOString();
                
                // Update tags
                currentEditItem.tags = [];
                qsa('.tag', qs('#editTags')).forEach(function(tagEl) {
                    var tagText = tagEl.textContent.replace('×', '').trim();
                    if (tagText) currentEditItem.tags.push(tagText);
                });
                
                // Check if this is a new item (not already in any stage)
                var alreadyExists = false;
                var stagesToCheck = EVENT_BRANDS.includes(currentEditBrand) ? EVENT_STAGES : EDIT_STAGES;
                stagesToCheck.forEach(function(stage) {
                    if (PIPELINES[currentEditBrand][stage] && PIPELINES[currentEditBrand][stage].some(function(i) { return i.id === currentEditItem.id; })) {
                        alreadyExists = true;
                    }
                });

                if (!alreadyExists) {
                    var defaultStage = EVENT_BRANDS.includes(currentEditBrand) ? 'planning' : 'ideas';
                    if (!PIPELINES[currentEditBrand][defaultStage]) {
                        PIPELINES[currentEditBrand][defaultStage] = [];
                    }
                    PIPELINES[currentEditBrand][defaultStage].push(currentEditItem);
                }

                refreshView(currentEditBrand);
                closeEditPanel();
                saveToFirebase();
                
                // If auto-schedule is enabled and item is in ready
                const autoSchedule = WORKFLOWS.find(w => w.id === 'auto-schedule');
                if (autoSchedule && autoSchedule.active && currentEditItem.stage === 'ready' && !currentEditItem.scheduledDate) {
                    currentEditItem.scheduledDate = addDays(todayISO(), 7);
                    showNotification('Auto-Scheduled', 'Content scheduled for ' + currentEditItem.scheduledDate, 'info');
                }
            }
        };
        
        function addTagToPanel(tagText) {
            if (!tagText.trim()) return;
            
            var tagsContainer = qs('#editTags');
            var tagEl = el('div', 'tag');
            tagEl.appendChild(el('span', null, tagText));
            
            var removeBtn = el('span', 'tag-remove', '×');
            removeBtn.onclick = function() {
                tagEl.remove();
            };
            
            tagEl.appendChild(removeBtn);
            tagsContainer.appendChild(tagEl);
        }
        
        // Tag input handler
        qs('#editTagInput').onkeydown = function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTagToPanel(this.value);
                this.value = '';
            }
        };
        
        // ---------- Template functions ----------
        window.showTemplateSelector = function(brandId) {
            var selector = qs('#templateSelector');
            selector.classList.add('show');
            selector.dataset.brandId = brandId;
        };
        
        window.closeTemplateSelector = function() {
            var selector = qs('#templateSelector');
            selector.classList.remove('show');
        };
        
        window.createFromTemplate = function(type) {
            var selector = qs('#templateSelector');
            var brandId = selector.dataset.brandId;
            var template = CONTENT_TEMPLATES[type];
            
            var newItem = createItem(
                template.title + todayISO(),
                'ideas',
                {
                    type: type,
                    tags: template.tags,
                    estimatedTime: template.estimatedTime,
                    notes: template.notes
                }
            );
            
            closeTemplateSelector();
            openEditPanel(newItem, brandId);
        };
        
        // Bulk Scheduler Modal
        window.openBulkScheduler = function(brandId) {
            const modal = qs('#bulkScheduler');
            modal.classList.add('show');
            modal.dataset.brandId = brandId;
            renderBulkOptions();
        };

        window.closeBulkScheduler = function() {
            qs('#bulkScheduler').classList.remove('show');
        };

        function renderBulkOptions() {
            const type = qs('input[name="scheduleType"]:checked').value;
            const container = qs('#bulkOptions');
            container.innerHTML = '';

            if (type === 'weekly') {
                container.innerHTML = `
                    <label>Content Type:
                        <select id="bulkContentType">
                            <option value="video">🎥 Video</option>
                            <option value="article">✏️ Article</option>
                            <option value="newsletter">📧 Newsletter</option>
                            <option value="social">📱 Social Post</option>
                        </select>
                    </label><br><br>
                    <label>Choose Days of the Week:</label><br>
                    ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map((day, i) =>
                        `<label><input type="checkbox" value="${i}"> ${day}</label>`
                    ).join(' ')}<br><br>
                    <label>Weeks Ahead: <input type="number" id="bulkWeeks" value="4" min="1" max="12"></label>
                `;
            } else {
                container.innerHTML = `
                    <label>Monthly Pattern:</label><br>
                    ${[1,2,3,4].map(i => `
                        <label>Week ${i}:
                            <select data-week="${i}" class="monthPattern">
                                <option value="video">🎥 Video</option>
                                <option value="article">✏️ Article</option>
                                <option value="newsletter">📧 Newsletter</option>
                                <option value="social">📱 Social Post</option>
                            </select>
                        </label><br><br>
                    `).join('')}
                    <label>Months Ahead: <input type="number" id="bulkMonths" value="3" min="1" max="12"></label>
                `;
            }

            qsa('input[name="scheduleType"]').forEach(radio =>
                radio.onchange = renderBulkOptions
            );
        }

        window.generateSchedule = function() {
            const brandId = qs('#bulkScheduler').dataset.brandId;
            const type = qs('input[name="scheduleType"]:checked').value;
            const today = new Date();
            const ideas = PIPELINES[brandId].ideas || [];

            if (type === 'weekly') {
                const days = qsa('#bulkOptions input[type="checkbox"]:checked').map(cb => parseInt(cb.value));
                const weeks = parseInt(qs('#bulkWeeks').value);
                const contentType = qs('#bulkContentType').value;
                const template = CONTENT_TEMPLATES[contentType];

                for (let w = 0; w < weeks; w++) {
                    days.forEach(day => {
                        const date = new Date();
                        date.setDate(today.getDate() + (7 * w) + ((day - today.getDay() + 7) % 7));
                        const dateStr = date.toISOString().slice(0, 10);

                        const item = createItem(`${template.title} ${dateStr}`, 'ideas', {
                            ...template,
                            type: contentType,
                            scheduledDate: dateStr
                        });

                        ideas.push(item);
                    });
                }
            } else {
                const months = parseInt(qs('#bulkMonths').value);
                const weekSelectors = qsa('.monthPattern');

                for (let m = 0; m < months; m++) {
                    const base = new Date(today.getFullYear(), today.getMonth() + m, 1);

                    weekSelectors.forEach((sel, i) => {
                        const contentType = sel.value;
                        const template = CONTENT_TEMPLATES[contentType];

                        const date = new Date(base);
                        date.setDate((i * 7) + 1);
                        const dateStr = date.toISOString().slice(0, 10);

                        const item = createItem(`${template.title} ${dateStr}`, 'ideas', {
                            ...template,
                            type: contentType,
                            scheduledDate: dateStr
                        });

                        ideas.push(item);
                    });
                }
            }

            PIPELINES[brandId].ideas = ideas;
            closeBulkScheduler();
            refreshView(brandId);
            saveToFirebase();
            showNotification('Schedule Created', `${ideas.length} items scheduled`, 'success');
        };
        
        window.openPublishedDirectory = function() {
            const modal = qs('#publishedDirectory');
            modal.classList.add('show');

            const brandFilter = qs('#publishedBrandFilter');
            brandFilter.innerHTML = '<option value="all">All Brands</option>';
            BRANDS.forEach(brand => {
                if (PIPELINES[brand.id]?.published?.length) {
                    const opt = document.createElement('option');
                    opt.value = brand.id;
                    opt.textContent = brand.name;
                    brandFilter.appendChild(opt);
                }
            });

            populatePublishedList();
        };

        window.closePublishedDirectory = function() {
            qs('#publishedDirectory').classList.remove('show');
        };

        function populatePublishedList() {
            const ul = qs('#publishedList');
            ul.innerHTML = '';

            const filterBrand = qs('#publishedBrandFilter').value;
            const keyword = qs('#publishedSearchInput').value.toLowerCase();

            BRANDS.forEach(brand => {
                if (filterBrand !== 'all' && brand.id !== filterBrand) return;

                const published = PIPELINES[brand.id]?.published || [];
                published.forEach(item => {
                    if (!item.title.toLowerCase().includes(keyword)) return;

                    const li = document.createElement('li');
                    li.style.padding = '.6rem 0';
                    li.style.borderBottom = '1px solid var(--border)';

                    li.innerHTML = `
                        <strong>${item.title}</strong><br>
                        <span style="font-size:.75rem; color: var(--text-m)">
                            ${brand.name} • ${item.scheduledDate || '—'} • 
                            ${item.metrics.views || 0} views • 
                            ${item.metrics.revenue ? ' + item.metrics.revenue : ''}
                        </span>
                    `;
                    ul.appendChild(li);
                });
            });
        }

        function filterPublishedList() {
            populatePublishedList();
        }

        qs('#publishedBrandFilter').onchange = populatePublishedList;
        
        // ---------- Content ideas generator ----------
        function getRandomIdea() {
            return CONTENT_IDEAS[Math.floor(Math.random() * CONTENT_IDEAS.length)];
        }
        
        // ---------- build UI ----------
        function buildNav() {
            var nav = qs('#nav');
            if (!nav) return;
            nav.innerHTML = '';
            
            // Add Overview button
            var overviewBtn = el('button', 'nav-btn', 'Overview');
            overviewBtn.dataset.id = 'overview';
            overviewBtn.onclick = function() { show('overview'); };
            nav.appendChild(overviewBtn);
            
            // Add Analytics button
            var analyticsBtn = el('button', 'nav-btn', 'Analytics');
            analyticsBtn.dataset.id = 'analytics';
            analyticsBtn.onclick = function() { show('analytics'); };
            nav.appendChild(analyticsBtn);
            
            // Then add brand buttons
            brandOrder.forEach(function(id) {
                var b = BRANDS.filter(function(br) { return br.id === id; })[0];
                if (!b) return;
                
                var btn = el('button', 'nav-btn', b.name);
                btn.dataset.id = id;
                btn.onclick = function() { show(id); };
                nav.appendChild(btn);
            });
            
            // Check for notifications
            checkForNotifications();
        }
        
        function checkForNotifications() {
            // Check for overdue items
            let hasOverdue = false;
            BRANDS.forEach(brand => {
                const stages = EVENT_BRANDS.includes(brand.id) ? EVENT_STAGES : EDIT_STAGES;
                stages.forEach(stage => {
                    const items = PIPELINES[brand.id][stage] || [];
                    items.forEach(item => {
                        if (item.scheduledDate && new Date(item.scheduledDate) < new Date() && stage !== 'published' && stage !== 'completed') {
                            hasOverdue = true;
                        }
                    });
                });
            });
            
            if (hasOverdue) {
                qsa('.nav-btn').forEach(btn => {
                    if (btn.dataset.id !== 'overview' && btn.dataset.id !== 'analytics') {
                        btn.classList.add('has-notification');
                    }
                });
            }
        }
        
        function buildOverview() {
            var grid = qs('#overview');
            if (!grid) return;
            grid.innerHTML = '';
            
            BRANDS.forEach(function(b) {
                var c = el('div', 'card');
                c.onclick = function() { show(b.id); };
                c.style.borderColor = b.accent;
                c.appendChild(el('span', 'badge ' + b.status, b.status));
                c.appendChild(el('div', 'brand', b.name));
                c.appendChild(el('div', 'desc', b.desc));
                
                var mrow = el('div', 'metrics');
                if (EVENT_BRANDS.indexOf(b.id) === -1) {
                    mrow.appendChild(metricBox(fmt(b.reach), 'Reach'));
                    mrow.appendChild(metricBox(' + fmt(b.revenue), 'Revenue'));
                    mrow.appendChild(metricBox(b.engage + '%', 'Engage'));
                } else {
                    mrow.appendChild(metricBox(b.events, 'Events'));
                    mrow.appendChild(metricBox(b.community, 'Community'));
                }
                c.appendChild(mrow);
                grid.appendChild(c);
            });
        }
        
        function metricBox(val, lbl) {
            var box = el('div', 'mbox');
            box.appendChild(el('div', 'mval', val));
            box.appendChild(el('div', 'mlbl', lbl));
            return box;
        }
        
        function buildViews() {
            var wrap = qs('#views');
            if (!wrap) return;
            wrap.innerHTML = '';
            
            BRANDS.forEach(function(b) {
                var v = el('div', 'view');
                v.id = 'view-' + b.id;
                
                // header with controls
                var head = el('div', 'p-head');
                head.appendChild(el('h2', null, b.name));
                
                var controls = el('div', 'p-controls');
                
                // view toggle
                var toggle = el('div', 'view-toggle');
                var pipeBtn = el('button', 'toggle-btn', 'Pipeline');
                var calBtn = el('button', 'toggle-btn', 'Calendar');
                
                pipeBtn.onclick = function() { toggleView(b.id, 'pipeline'); };
                calBtn.onclick = function() { toggleView(b.id, 'calendar'); };
                
                toggle.appendChild(pipeBtn);
                toggle.appendChild(calBtn);
                controls.appendChild(toggle);
                
                // multi-brand option (only show in calendar view)
                var multiCheck = el('div', 'multi-brand');
                multiCheck.style.display = 'none';
                var checkbox = el('input');
                checkbox.type = 'checkbox';
                checkbox.onchange = function() {
                    MULTI_BRAND_VIEW = this.checked;
                    if (VIEW_STATES[b.id] === 'calendar') buildCalendar(b.id);
                };
                multiCheck.appendChild(checkbox);
                multiCheck.appendChild(el('span', null, 'Multi-brand'));
                controls.appendChild(multiCheck);
                
                // add button
                var addBtn = el('button', 'add', (EVENT_BRANDS.indexOf(b.id) === -1) ? '+ Add Content' : '+ Add Event');
                addBtn.style.background = b.accent;
                addBtn.onclick = function() { addItem(b.id); };
                controls.appendChild(addBtn);
                
                head.appendChild(controls);
                v.appendChild(head);
                
                // Add quick actions bar for content brands
                if (EVENT_BRANDS.indexOf(b.id) === -1) {
                    var quickActions = el('div', 'quick-actions');
                    
                    var templateBtn = el('button', 'quick-action-btn');
                    templateBtn.innerHTML = '<span class="quick-action-icon">📋</span> Use Template';
                    templateBtn.onclick = function() { showTemplateSelector(b.id); };
                    quickActions.appendChild(templateBtn);
                    
                    var bulkBtn = el('button', 'quick-action-btn');
                    bulkBtn.innerHTML = '<span class="quick-action-icon">⚡</span> Bulk Schedule';
                    bulkBtn.onclick = function() { openBulkScheduler(b.id); };
                    quickActions.appendChild(bulkBtn);
                    
                    var exportBtn = el('button', 'quick-action-btn');
                    exportBtn.innerHTML = '<span class="quick-action-icon">📥</span> Export Content';
                    exportBtn.onclick = function() { exportBrandContent(b.id); };
                    quickActions.appendChild(exportBtn);
                    
                    const publishedBtn = el('button', 'quick-action-btn');
                    publishedBtn.innerHTML = '<span class="quick-action-icon">📁</span> View Published';
                    publishedBtn.onclick = function() { openPublishedDirectory(); };
                    quickActions.appendChild(publishedBtn);
                    
                    const aiBtn = el('button', 'quick-action-btn');
                    aiBtn.innerHTML = '<span class="quick-action-icon">🤖</span> AI Suggestions';
                    aiBtn.onclick = function() { toggleAISuggestions(); };
                    quickActions.appendChild(aiBtn);

                    v.appendChild(quickActions);
                    
                    // Add filter bar
                    var filterBar = el('div', 'filter-bar');
                    
                    var searchInput = el('input', 'filter-input');
                    searchInput.type = 'text';
                    searchInput.placeholder = 'Search content...';
                    searchInput.oninput = debounce(function() {
                        filterContent(b.id, searchInput.value);
                    }, 300);
                    filterBar.appendChild(searchInput);
                    
                    var typeFilter = el('select', 'filter-select');
                    typeFilter.innerHTML = `
                        <option value="">All Types</option>
                        <option value="video">🎥 Videos</option>
                        <option value="article">✏️ Articles</option>
                        <option value="newsletter">📧 Newsletters</option>
                        <option value="social">📱 Social</option>
                    `;
                    typeFilter.onchange = function() {
                        filterByType(b.id, typeFilter.value);
                    };
                    filterBar.appendChild(typeFilter);
                    
                    var priorityFilter = el('select', 'filter-select');
                    priorityFilter.innerHTML = `
                        <option value="">All Priorities</option>
                        <option value="high">🔴 High</option>
                        <option value="medium">🟡 Medium</option>
                        <option value="low">🟢 Low</option>
                    `;
                    priorityFilter.onchange = function() {
                        filterByPriority(b.id, priorityFilter.value);
                    };
                    filterBar.appendChild(priorityFilter);
                    
                    v.appendChild(filterBar);
                    
                    // Add ideas generator
                    var ideasGen = el('div', 'ideas-generator');
                    ideasGen.innerHTML = '<h3>Need inspiration?</h3>';
                    var ideaBtn = el('button', null, '💡 Generate Content Idea');
                    ideaBtn.onclick = function() {
                        var ideaDiv = qs('#idea-' + b.id);
                        if (!ideaDiv) {
                            ideaDiv = el('div', 'idea-suggestion');
                            ideaDiv.id = 'idea-' + b.id;
                            ideasGen.appendChild(ideaDiv);
                        }
                        ideaDiv.textContent = '"' + getRandomIdea() + '"';
                    };
                    ideasGen.appendChild(ideaBtn);
                    v.appendChild(ideasGen);
                    
                    // Add progress tracker
                    var progress = buildProgressTracker(b);
                    v.appendChild(progress);
                    
                    // Add today's summary
                    v.appendChild(buildTodaySummary(b.id));
                    
                    // Add workflow panel
                    v.appendChild(buildWorkflowPanel(b.id));
                }
                
                // brand metrics
                var bm = el('div', 'brand-metrics');
                if (EVENT_BRANDS.indexOf(b.id) === -1) {
                    bm.appendChild(brandBox(fmt(b.reach), 'Reach'));
                    bm.appendChild(brandBox(' + fmt(b.revenue), 'Revenue'));
                    bm.appendChild(brandBox(b.engage + '%', 'Engage'));
                    bm.appendChild(brandBox(getContentCount(b.id), 'Content'));
                } else {
                    bm.appendChild(brandBox(b.events, 'Events'));
                    bm.appendChild(brandBox(b.community, 'Community'));
                }
                v.appendChild(bm);
                
                // pipeline view
                var pipelineView = el('div', 'pipeline-view');
                pipelineView.id = 'pipeline-' + b.id;
                buildPipeline(b, pipelineView);
                v.appendChild(pipelineView);
                
                // calendar view
                var calendarView = el('div', 'calendar');
                calendarView.id = 'calendar-' + b.id;
                v.appendChild(calendarView);
                
                wrap.appendChild(v);
            });
        }
        
        function buildProgressTracker(brand) {
            var progress = el('div', 'progress-section');
            
            var header = el('div', 'progress-header');
            header.appendChild(el('h3', null, 'Monthly Progress'));
            
            var stats = el('span', null, getMonthlyStats(brand.id));
            header.appendChild(stats);
            progress.appendChild(header);
            
            var bar = el('div', 'progress-bar');
            var fill = el('div', 'progress-fill');
            var percentage = getMonthlyProgress(brand.id);
            fill.style.width = percentage + '%';
            bar.appendChild(fill);
            progress.appendChild(bar);
            
            var text = el('div', 'progress-text');
            text.innerHTML = '<span>' + percentage + '% Complete</span><span>Keep going! 💪</span>';
            progress.appendChild(text);
            
            return progress;
        }
        
        function buildTodaySummary(brandId) {
            const todaySummary = el('div', 'progress-section daily-summary-panel');
            todaySummary.style.marginBottom = '1.5rem';

            const header = el('div', 'progress-header');
            header.appendChild(el('h3', null, "Today's Schedule"));
            todaySummary.appendChild(header);

            const list = el('ul');
            list.style.listStyle = 'none';
            list.style.paddingLeft = '0';

            const todayStr = todayISO();
            const stages = EDIT_STAGES;

            stages.forEach(stage => {
                const items = PIPELINES[brandId][stage] || [];
                items.forEach(item => {
                    if (item.scheduledDate === todayStr) {
                        const li = el('li');
                        li.style.marginBottom = '.6rem';
                        li.innerHTML = `
                            <span class="content-icon type-${item.type}">${getContentIcon(item.type)}</span>
                            <strong>${item.title}</strong>
                            <span style="font-size:.75rem; color: var(--text-m); margin-left: .5rem;">(${stage})</span>
                        `;
                        list.appendChild(li);
                    }
                });
            });

            if (list.children.length === 0) {
                const empty = el('li', null, 'No items scheduled today.');
                empty.style.color = 'var(--text-m)';
                list.appendChild(empty);
            }

            todaySummary.appendChild(list);
            return todaySummary;
        }
        
        function buildWorkflowPanel(brandId) {
            const panel = el('div', 'workflow-panel');
            
            const header = el('div', 'workflow-header');
            header.appendChild(el('h3', null, '⚡ Automation'));
            panel.appendChild(header);
            
            WORKFLOWS.forEach(workflow => {
                const item = el('div', 'workflow-item');
                
                const icon = el('span', 'workflow-icon', workflow.icon);
                item.appendChild(icon);
                
                const info = el('div', 'workflow-info');
                info.appendChild(el('div', 'workflow-title', workflow.title));
                info.appendChild(el('div', 'workflow-desc', workflow.desc));
                item.appendChild(info);
                
                const toggle = el('div', 'workflow-toggle' + (workflow.active ? ' active' : ''));
                toggle.onclick = function() {
                    workflow.active = !workflow.active;
                    toggle.classList.toggle('active');
                    showNotification('Workflow Updated', workflow.title + ' is now ' + (workflow.active ? 'enabled' : 'disabled'), 'info');
                };
                item.appendChild(toggle);
                
                panel.appendChild(item);
            });
            
            return panel;
        }
        
        // Filter functions
        function filterContent(brandId, query) {
            const lowerQuery = query.toLowerCase();
            const stages = EVENT_BRANDS.includes(brandId) ? EVENT_STAGES : EDIT_STAGES;
            
            stages.forEach(stage => {
                const items = qsa(`#pipeline-${brandId} .col[data-stage="${stage}"] .item`);
                items.forEach(item => {
                    const title = item.dataset.title.toLowerCase();
                    item.style.display = title.includes(lowerQuery) ? 'flex' : 'none';
                });
            });
        }
        
        function filterByType(brandId, type) {
            const stages = EVENT_BRANDS.includes(brandId) ? EVENT_STAGES : EDIT_STAGES;
            
            stages.forEach(stage => {
                const items = qsa(`#pipeline-${brandId} .col[data-stage="${stage}"] .item`);
                items.forEach(item => {
                    if (type) {
                        const itemType = getContentType(item.dataset.title);
                        item.style.display = itemType === type ? 'flex' : 'none';
                    } else {
                        item.style.display = 'flex';
                    }
                });
            });
        }
        
        function filterByPriority(brandId, priority) {
            const stages = EVENT_BRANDS.includes(brandId) ? EVENT_STAGES : EDIT_STAGES;
            
            stages.forEach(stage => {
                const items = PIPELINES[brandId][stage] || [];
                const itemElements = qsa(`#pipeline-${brandId} .col[data-stage="${stage}"] .item`);
                
                itemElements.forEach((itemEl, index) => {
                    const item = items[index];
                    if (item) {
                        if (priority) {
                            itemEl.style.display = item.priority === priority ? 'flex' : 'none';
                        } else {
                            itemEl.style.display = 'flex';
                        }
                    }
                });
            });
        }
        
        function getContentCount(brandId) {
            var count = 0;
            EDIT_STAGES.forEach(function(stage) {
                if (PIPELINES[brandId][stage]) {
                    count += PIPELINES[brandId][stage].length;
                }
            });
            return count;
        }
        
        function getMonthlyStats(brandId) {
            var published = PIPELINES[brandId].published ? PIPELINES[brandId].published.length : 0;
            var inProgress = PIPELINES[brandId].inProgress ? PIPELINES[brandId].inProgress.length : 0;
            return published + ' published, ' + inProgress + ' in progress';
        }
        
        function getMonthlyProgress(brandId) {
            // Simple calculation: published items / total items * 100
            var total = getContentCount(brandId);
            var published = PIPELINES[brandId].published ? PIPELINES[brandId].published.length : 0;
            return total > 0 ? Math.round((published / total) * 100) : 0;
        }
        
        function exportBrandContent(brandId) {
            var brand = BRANDS.find(function(b) { return b.id === brandId; });
            var data = {
                brand: brand.name,
                exportDate: new Date().toISOString(),
                pipeline: PIPELINES[brandId],
                calendar: CALENDAR_DATA[brandId]
            };
            
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = brand.name.toLowerCase().replace(/\s+/g, '-') + '-content-' + todayISO() + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Export Complete', 'Content exported for ' + brand.name, 'success');
        }
        
        function buildPipeline(brand, container) {
            var pipe = el('div', 'pipeline');
            var stages = (EVENT_BRANDS.indexOf(brand.id) === -1) ? EDIT_STAGES : EVENT_STAGES;
            
            stages.forEach(function(stage) {
                var col = el('div', 'col');
                col.dataset.brand = brand.id;
                col.dataset.stage = stage;
                
                var chead = el('div', 'c-head');
                chead.appendChild(el('span', null, stage.replace(/([A-Z])/g, ' $1').replace(/^./, function(ch) { return ch.toUpperCase(); })));
                var count = el('span', 'c-count', '0');
                chead.appendChild(count);
                col.appendChild(chead);
                
                var list = el('div', 'list');
                (PIPELINES[brand.id][stage] || []).forEach(function(item) {
                    list.appendChild(itemElem(item, stage, brand.id));
                });
                col.appendChild(list);
                pipe.appendChild(col);
                
                // Enable drag and drop
                if (typeof Sortable !== 'undefined') {
                    var sortable = new Sortable(list, {
                        group: brand.id,
                        animation: 150,
                        dragClass: 'dragging',
                        onStart: function(evt) {
                            evt.item.classList.add('dragging');
                        },
                        onEnd: function(evt) {
                            var itemEl = evt.item;
                            itemEl.classList.remove('dragging');
                            var itemId = itemEl.dataset.itemId;
                            var fromStage = evt.from.closest('.col').dataset.stage;
                            var toStage = evt.to.closest('.col').dataset.stage;
                            var brandId = evt.to.closest('.col').dataset.brand;

                            // If no change, do nothing
                            if (fromStage === toStage && evt.oldIndex === evt.newIndex) return;

                            var movedItem = null;
                            var fromIndex = -1;

                            // Find and remove from old stage
                            if (PIPELINES[brandId][fromStage]) {
                                for (var i = 0; i < PIPELINES[brandId][fromStage].length; i++) {
                                    if (PIPELINES[brandId][fromStage][i].id === itemId) {
                                        movedItem = PIPELINES[brandId][fromStage][i];
                                        fromIndex = i;
                                        break;
                                    }
                                }
                            }

                            if (movedItem && fromIndex !== -1) {
                                PIPELINES[brandId][fromStage].splice(fromIndex, 1);

                                // Update metadata
                                movedItem.stage = toStage;
                                movedItem.modified = new Date().toISOString();

                                // Auto-schedule if moved to ready
                                const autoSchedule = WORKFLOWS.find(w => w.id === 'auto-schedule');
                                if (autoSchedule && autoSchedule.active && toStage === 'ready' && !movedItem.scheduledDate) {
                                    movedItem.scheduledDate = addDays(todayISO(), 7);
                                    showNotification('Auto-Scheduled', 'Content scheduled for ' + movedItem.scheduledDate, 'info');
                                }

                                // Ensure destination stage exists
                                if (!PIPELINES[brandId][toStage]) {
                                    PIPELINES[brandId][toStage] = [];
                                }

                                // Insert at new position
                                PIPELINES[brandId][toStage].splice(evt.newIndex, 0, movedItem);
                                
                                // Add target column animation
                                evt.to.closest('.col').classList.add('drag-over');
                                setTimeout(() => {
                                    evt.to.closest('.col').classList.remove('drag-over');
                                }, 500);
                            }

                            refreshView(brandId);
                            saveToFirebase();
                        }
                    });

                    sortableInstances.push(sortable);
                }
            });
            
            container.appendChild(pipe);
        }
        
        function buildCalendar(brandId) {
            var brand = BRANDS.find(function(b) { return b.id === brandId; });
            if (!brand) return;
            
            var calContainer = qs('#calendar-' + brandId);
            if (!calContainer) return;
            calContainer.innerHTML = '';
            
            var currentMonth = CURRENT_MONTH[brandId];
            
            // Calendar header
            var header = el('div', 'cal-header');
            
            var prevBtn = el('div', 'cal-nav', '‹');
            prevBtn.onclick = function() {
                if (currentMonth.month === 0) {
                    currentMonth.month = 11;
                    currentMonth.year--;
                } else {
                    currentMonth.month--;
                }
                buildCalendar(brandId);
            };
            
            var title = el('div', 'cal-title', getMonthName(currentMonth.month) + ' ' + currentMonth.year);
            
            var nextBtn = el('div', 'cal-nav', '›');
            nextBtn.onclick = function() {
                if (currentMonth.month === 11) {
                    currentMonth.month = 0;
                    currentMonth.year++;
                } else {
                    currentMonth.month++;
                }
                buildCalendar(brandId);
            };
            
            header.appendChild(prevBtn);
            header.appendChild(title);
            header.appendChild(nextBtn);
            calContainer.appendChild(header);
            
            // Calendar grid
            var grid = el('div', 'cal-grid');
            
            // Day headers
            var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(function(day, i) {
                var dayHeader = el('div', 'cal-day-header' + (i === 0 || i === 6 ? ' weekend' : ''), day);
                grid.appendChild(dayHeader);
            });
            
            // Date cells
            var dates = getMonthDates(currentMonth.year, currentMonth.month);
            
            dates.forEach(function(dateInfo) {
                var dateCell = el('div', 'cal-date');
                if (!dateInfo.isCurrentMonth) dateCell.classList.add('other-month');
                if (dateInfo.isToday) dateCell.classList.add('today');
                if (dateInfo.isWeekend) dateCell.classList.add('weekend');
                
                var dateNum = el('div', 'cal-date-num', dateInfo.day);
                dateCell.appendChild(dateNum);
                
                var itemsContainer = el('div', 'cal-items');
                
                // Add items for this date
                var itemsForDate = [];
                
                if (MULTI_BRAND_VIEW) {
                    // Show items from all brands
                    BRANDS.forEach(function(b) {
                        if (CALENDAR_DATA[b.id] && CALENDAR_DATA[b.id][dateInfo.dateStr]) {
                            CALENDAR_DATA[b.id][dateInfo.dateStr].forEach(function(item) {
                                var extItem = Object.assign({}, item);
                                extItem.brandColor = b.accent;
                                extItem.brandId = b.id;
                                itemsForDate.push(extItem);
                            });
                        }
                    });
                } else {
                    // Show items only for current brand
                    if (CALENDAR_DATA[brandId] && CALENDAR_DATA[brandId][dateInfo.dateStr]) {
                        itemsForDate = CALENDAR_DATA[brandId][dateInfo.dateStr].map(function(item) {
                            var extItem = Object.assign({}, item);
                            extItem.brandColor = brand.accent;
                            extItem.brandId = brandId;
                            return extItem;
                        });
                    }
                }
                
                // Display items (max 3, then show "more")
                var maxVisible = 3;
                itemsForDate.slice(0, maxVisible).forEach(function(item) {
                    var itemEl = el('div', 'cal-item ' + item.stage + ' type-' + (item.type || getContentType(item.title)), item.title);
                    itemEl.style.background = MULTI_BRAND_VIEW ? item.brandColor : brand.accent;
                    itemEl.dataset.itemId = item.id;
                    itemEl.dataset.brandId = item.brandId;
                    itemEl.dataset.date = dateInfo.dateStr;
                    
                    // Add delete button
                    var deleteBtn = el('button', 'cal-item-delete', '×');
                    deleteBtn.onclick = function(e) {
                        e.stopPropagation();
                        deleteCalendarItem(item.brandId, item.id, dateInfo.dateStr);
                    };
                    itemEl.appendChild(deleteBtn);
                    
                    // Add tooltip
                    itemEl.title = item.title + ' (' + item.stage + ')';
                    
                    itemEl.onclick = function(e) {
                        e.stopPropagation();
                        openEditPanel(item, item.brandId);
                    };
                    
                    itemsContainer.appendChild(itemEl);
                });
                
                if (itemsForDate.length > maxVisible) {
                    var moreEl = el('div', 'cal-more', '+' + (itemsForDate.length - maxVisible) + ' more');
                    moreEl.onclick = function() {
                        // Create detailed view
                        const detailView = el('div', 'empty-state');
                        detailView.innerHTML = `<h3>Items for ${dateInfo.dateStr}</h3>`;
                        itemsForDate.forEach(item => {
                            detailView.innerHTML += `<p>• ${item.title} (${item.stage})</p>`;
                        });
                        alert(detailView.innerText);
                    };
                    itemsContainer.appendChild(moreEl);
                }
                
                dateCell.appendChild(itemsContainer);
                
                // Make date clickable for adding items
                dateCell.onclick = function(e) {
                    if (e.target === dateCell || e.target === dateNum || e.target === itemsContainer) {
                        addItemToDate(brandId, dateInfo.dateStr);
                    }
                };
                
                grid.appendChild(dateCell);
            });
            
            calContainer.appendChild(grid);
        }
        
        function brandBox(val, lbl) {
            var b = el('div', 'brand-mbox');
            b.appendChild(el('div', 'brand-mval', val));
            b.appendChild(el('div', 'brand-mlabel', lbl));
            return b;
        }
        
        function itemElem(item, stage, brandId) {
            var it = el('div', 'item ' + (stage || ''));
            
            var content = el('div', 'item-content');
            
            // Content type icon
            if (item.type) {
                content.appendChild(el('span', 'content-icon', getContentIcon(item.type)));
            }
            
            // Priority badge
            if (item.priority && item.priority !== 'medium') {
                var priorityBadge = el('span', 'priority-badge priority-' + item.priority, 
                                      item.priority === 'high' ? '!' : 
                                      item.priority === 'low' ? '↓' : '');
                content.appendChild(priorityBadge);
            }
            
            // Title
            var titleSpan = el('span', 'item-title', item.title);
            titleSpan.ondblclick = function() {
                startInlineEdit(it, item, brandId);
            };
            content.appendChild(titleSpan);
            
            // Status indicator for scheduled items
            if (item.scheduledDate) {
                var status = getDateStatus(item.scheduledDate);
                if (status) {
                    var statusInd = el('span', 'status-indicator');
                    statusInd.appendChild(el('span', 'status-dot ' + status.class));
                    statusInd.appendChild(el('span', null, status.text));
                    content.appendChild(statusInd);
                }
            }
            
            // Scheduled date
            if (item.scheduledDate) {
                content.appendChild(el('span', 'item-date', item.scheduledDate));
            }
            
            // Collaborators
            if (item.collaborators && item.collaborators.length > 0) {
                var collabInd = el('span', 'collab-indicator');
                item.collaborators.slice(0, 3).forEach(collab => {
                    var avatar = el('div', 'collab-avatar', collab.charAt(0).toUpperCase());
                    collabInd.appendChild(avatar);
                });
                content.appendChild(collabInd);
            }
            
            it.appendChild(content);
            
            // Action buttons
            var actions = el('div', 'item-actions');
            
            var editBtn = el('button', 'item-action edit', '✏️');
            editBtn.onclick = function(e) {
                e.stopPropagation();
                openEditPanel(item, brandId);
            };
            actions.appendChild(editBtn);
            
            var deleteBtn = el('button', 'item-action delete', '×');
            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                it.classList.add('deleting');
                setTimeout(function() {
                    deleteItem(brandId, item.id, stage);
                }, 300);
            };
            actions.appendChild(deleteBtn);
            
            it.appendChild(actions);
            
            // Progress bar for in-progress items
            if (stage === 'inProgress' && item.progress) {
                var progressBar = el('div', 'item-progress');
                var progressFill = el('div', 'item-progress-fill');
                progressFill.style.width = item.progress + '%';
                progressBar.appendChild(progressFill);
                it.appendChild(progressBar);
            }
            
            it.dataset.itemId = item.id;
            it.dataset.id = item.id;
            it.dataset.title = item.title;
            it.dataset.stage = stage;
            
            return it;
        }
        
        function getDateStatus(dateStr) {
            var date = new Date(dateStr);
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);
            
            var diffDays = Math.floor((date - today) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return { class: 'overdue', text: Math.abs(diffDays) + 'd overdue' };
            } else if (diffDays === 0) {
                return { class: 'due-soon', text: 'Today!' };
            } else if (diffDays <= 3) {
                return { class: 'due-soon', text: diffDays + 'd' };
            }
            return null;
        }
        
        // ---------- interactions ----------
        function show(id) {
            if (id === 'analytics') {
                showAnalytics();
                return;
            }
            ['overview', 'analytics'].concat(brandOrder).forEach(function(bid) {
                var navBtn = qs('.nav-btn[data-id="' + bid + '"]');
                if (navBtn) {
                    navBtn.classList[bid === id ? 'add' : 'remove']('active');
                }
            });
            
            var overview = qs('#overview');
            if (overview) {
                overview.style.display = (id === 'overview') ? 'grid' : 'none';
            }
            
            var views = qs('#views');
            if (views) {
                Array.prototype.forEach.call(views.children, function(v) {
                    v.classList.remove('active');
                });
            }
            
            if (id !== 'overview' && id !== 'analytics') {
                var view = qs('#view-' + id);
                if (view) {
                    view.classList.add('active');
                    
                    // Update toggle buttons
                    var pipeBtn = view.querySelector('.toggle-btn:first-child');
                    var calBtn = view.querySelector('.toggle-btn:last-child');
                    var multiBrand = view.querySelector('.multi-brand');
                    var pipelineView = qs('#pipeline-' + id);
                    var calendarView = qs('#calendar-' + id);
                    var toggle = view.querySelector('.view-toggle');
                    
                    if (VIEW_STATES[id] === 'pipeline') {
                        if (pipeBtn) pipeBtn.classList.add('active');
                        if (calBtn) calBtn.classList.remove('active');
                        if (pipelineView) pipelineView.style.display = 'flex';
                        if (calendarView) calendarView.classList.remove('active');
                        if (multiBrand) multiBrand.style.display = 'none';
                        if (toggle) toggle.classList.remove('calendar');
                    } else {
                        if (pipeBtn) pipeBtn.classList.remove('active');
                        if (calBtn) calBtn.classList.add('active');
                        if (pipelineView) pipelineView.style.display = 'none';
                        if (calendarView) calendarView.classList.add('active');
                        if (multiBrand) multiBrand.style.display = 'flex';
                        if (toggle) toggle.classList.add('calendar');
                        buildCalendar(id);
                    }
                }
            }
            
            updateAll();
        }
        
        function toggleView(brandId, viewType) {
            VIEW_STATES[brandId] = viewType;
            show(brandId);
        }
        
        function addItem(bid) {
            if (EVENT_BRANDS.indexOf(bid) === -1) {
                // For content brands, show template selector first
                showTemplateSelector(bid);
            } else {
                // For event brands, create directly
                var newItem = createItem('', 'planning');
                openEditPanel(newItem, bid);
            }
        }
        
        function addItemToDate(brandId, dateStr) {
            var title = prompt('Enter title for ' + dateStr + ':');
            if (title) {
                var newItem = createItem(title, 'planning', {scheduledDate: dateStr});
                addToCalendar(brandId, dateStr, newItem, 'planning');
                buildCalendar(brandId);
                updateAll();
                saveToFirebase();
            }
        }
        
        function updateCounts() {
            var cols = qsa('.col');
            cols.forEach(function(col) {
                var cnt = col.querySelectorAll('.item').length;
                var badge = col.querySelector('.c-count');
                if (badge) { badge.textContent = cnt; }
            });
        }
        
        function updateTotals() {
            var totalItems = 0, totalReach = 0, totalRevenue = 0, totalEvents = 0;
            
            BRANDS.forEach(function(b) {
                var stages = (EVENT_BRANDS.indexOf(b.id) === -1) ? EDIT_STAGES : EVENT_STAGES;
                stages.forEach(function(s) {
                    if (PIPELINES[b.id][s]) {
                        totalItems += PIPELINES[b.id][s].length;
                    }
                });
                
                // Add calendar items to total
                if (CALENDAR_DATA[b.id]) {
                    Object.keys(CALENDAR_DATA[b.id]).forEach(function(date) {
                        totalItems += CALENDAR_DATA[b.id][date].length;
                    });
                }
                
                if (EVENT_BRANDS.indexOf(b.id) === -1) {
                    totalReach += b.reach;
                    totalRevenue += b.revenue;
                } else {
                    totalEvents += b.events;
                }
            });
            
            var totals = qs('#totals');
            if (totals) {
                totals.innerHTML = '';
                totals.appendChild(totalBox(totalItems, 'Pipeline Items'));
                totals.appendChild(totalBox(fmt(totalReach), 'Total Reach'));
                totals.appendChild(totalBox(' + fmt(totalRevenue), 'Total Revenue'));
                totals.appendChild(totalBox(totalEvents, 'Total Events'));
            }
        }
        
        function totalBox(val, lbl) {
            var t = el('div', 'tot');
            t.appendChild(el('div', 'tot-val', val));
            t.appendChild(el('div', 'tot-lbl', lbl));
            return t;
        }
        
        function updateAll() {
            updateCounts();
            updateTotals();
            checkForNotifications();
        }
        
        // ---------- Analytics Dashboard ----------
        var ANALYTICS_CHARTS = {};
        var CURRENT_DATE_RANGE = '30d';

        function buildAnalyticsView() {
            // Create analytics view container
            var views = qs('#views');
            var analyticsView = el('div', 'analytics-view');
            analyticsView.id = 'analytics-view';
            
            // Header with date range selector
            var header = el('div', 'analytics-header');
            header.appendChild(el('h2', null, 'Analytics Dashboard'));
            
            var dateRange = el('div', 'date-range-selector');
            ['7d', '30d', '90d', 'All'].forEach(function(range) {
                var btn = el('button', 'date-range-btn', range === '7d' ? '7 Days' : 
                                                          range === '30d' ? '30 Days' : 
                                                          range === '90d' ? '90 Days' : 'All Time');
                btn.dataset.range = range;
                if (range === '30d') btn.classList.add('active');
                btn.onclick = function() {
                    qsa('.date-range-btn').forEach(function(b) { b.classList.remove('active'); });
                    btn.classList.add('active');
                    CURRENT_DATE_RANGE = range;
                    updateAnalytics();
                };
                dateRange.appendChild(btn);
            });
            header.appendChild(dateRange);
            analyticsView.appendChild(header);
            
            // Metrics grid
            var metricsGrid = el('div', 'analytics-grid');
            
            // Total Content card
            var totalCard = createMetricCard('Total Content', calculateTotalContent(), '+12% from last period');
            metricsGrid.appendChild(totalCard);
            
            // Total Views card
            var viewsCard = createMetricCard('Total Views', calculateTotalViews(), '+25% from last period');
            metricsGrid.appendChild(viewsCard);
            
            // Average Engagement card
            var engageCard = createMetricCard('Avg Engagement', calculateAvgEngagement() + '%', '+3.2% from last period');
            metricsGrid.appendChild(engageCard);
            
            // Revenue card
            var revenueCard = createMetricCard('Total Revenue', ' + calculateTotalRevenue(), '+18% from last period');
            metricsGrid.appendChild(revenueCard);
            
            analyticsView.appendChild(metricsGrid);
            
            // Charts grid
            var chartsGrid = el('div', 'analytics-grid');
            
            // Content over time chart
            var contentChartCard = el('div', 'analytics-card');
            contentChartCard.style.gridColumn = 'span 2';
            var contentChartHeader = el('div', 'analytics-card-header');
            contentChartHeader.appendChild(el('h3', 'analytics-card-title', 'Content Production Over Time'));
            contentChartCard.appendChild(contentChartHeader);
            var contentChartContainer = el('div', 'chart-container');
            contentChartContainer.innerHTML = '<canvas id="contentChart"></canvas>';
            contentChartCard.appendChild(contentChartContainer);
            chartsGrid.appendChild(contentChartCard);
            
            // Brand performance chart
            var brandChartCard = el('div', 'analytics-card');
            var brandChartHeader = el('div', 'analytics-card-header');
            brandChartHeader.appendChild(el('h3', 'analytics-card-title', 'Brand Performance'));
            brandChartCard.appendChild(brandChartHeader);
            var brandChartContainer = el('div', 'chart-container');
            brandChartContainer.innerHTML = '<canvas id="brandChart"></canvas>';
            brandChartCard.appendChild(brandChartContainer);
            chartsGrid.appendChild(brandChartCard);
            
            analyticsView.appendChild(chartsGrid);
            
            // Additional insights
            var insightsGrid = el('div', 'analytics-grid');
            
            // Top performing content
            var topContentCard = el('div', 'analytics-card');
            var topContentHeader = el('div', 'analytics-card-header');
            topContentHeader.appendChild(el('h3', 'analytics-card-title', 'Top Performing Content'));
            topContentCard.appendChild(topContentHeader);
            var topContentList = el('ul', 'top-content-list');
            getTopContent().forEach(function(item) {
                var li = el('li', 'top-content-item');
                li.appendChild(el('span', 'content-title', item.title));
                li.appendChild(el('span', 'content-metric', fmt(item.views) + ' views'));
                topContentList.appendChild(li);
            });
            topContentCard.appendChild(topContentList);
            insightsGrid.appendChild(topContentCard);
            
            // Brand breakdown
            var brandBreakdownCard = el('div', 'analytics-card');
            var brandBreakdownHeader = el('div', 'analytics-card-header');
            brandBreakdownHeader.appendChild(el('h3', 'analytics-card-title', 'Brand Breakdown'));
            brandBreakdownCard.appendChild(brandBreakdownHeader);
            var brandPerfGrid = el('div', 'brand-performance-grid');
            BRANDS.forEach(function(brand) {
                if (EVENT_BRANDS.indexOf(brand.id) === -1) {
                    var perfCard = el('div', 'brand-perf-card');
                    perfCard.style.borderTop = '3px solid ' + brand.accent;
                    perfCard.appendChild(el('div', 'brand-perf-name', brand.name));
                    perfCard.appendChild(el('div', 'brand-perf-value', getPublishedCount(brand.id)));
                    perfCard.appendChild(el('div', 'analytics-trend', 'Published'));
                    brandPerfGrid.appendChild(perfCard);
                }
            });
            brandBreakdownCard.appendChild(brandPerfGrid);
            insightsGrid.appendChild(brandBreakdownCard);
            
            analyticsView.appendChild(insightsGrid);
            
            views.appendChild(analyticsView);
        }

        function createMetricCard(title, value, trend) {
            var card = el('div', 'analytics-card');
            card.appendChild(el('div', 'analytics-card-title', title));
            card.appendChild(el('div', 'analytics-metric', value));
            var trendEl = el('div', 'analytics-trend ' + (trend.includes('+') ? 'trend-up' : 'trend-down'), trend);
            card.appendChild(trendEl);
            return card;
        }

        function calculateTotalContent() {
            var total = 0;
            BRANDS.forEach(function(brand) {
                var stages = EVENT_BRANDS.indexOf(brand.id) === -1 ? EDIT_STAGES : EVENT_STAGES;
                stages.forEach(function(stage) {
                    if (PIPELINES[brand.id][stage]) {
                        total += PIPELINES[brand.id][stage].length;
                    }
                });
            });
            return total;
        }

        function calculateTotalViews() {
            var total = 0;
            BRANDS.forEach(function(brand) {
                if (PIPELINES[brand.id].published) {
                    PIPELINES[brand.id].published.forEach(function(item) {
                        total += item.metrics.views || 0;
                    });
                }
            });
            return fmt(total);
        }

        function calculateAvgEngagement() {
            var totalEngagement = 0;
            var count = 0;
            BRANDS.forEach(function(brand) {
                if (PIPELINES[brand.id].published) {
                    PIPELINES[brand.id].published.forEach(function(item) {
                        if (item.metrics.engagement) {
                            totalEngagement += item.metrics.engagement;
                            count++;
                        }
                    });
                }
            });
            return count > 0 ? (totalEngagement / count).toFixed(1) : '0';
        }

        function calculateTotalRevenue() {
            var total = 0;
            BRANDS.forEach(function(brand) {
                if (PIPELINES[brand.id].published) {
                    PIPELINES[brand.id].published.forEach(function(item) {
                        total += item.metrics.revenue || 0;
                    });
                }
            });
            return fmt(total);
        }

        function getTopContent() {
            var allContent = [];
            BRANDS.forEach(function(brand) {
                if (PIPELINES[brand.id].published) {
                    PIPELINES[brand.id].published.forEach(function(item) {
                        allContent.push({
                            title: item.title,
                            views: item.metrics.views || 0,
                            brand: brand.name
                        });
                    });
                }
            });
            return allContent.sort(function(a, b) { return b.views - a.views; }).slice(0, 5);
        }

        function getPublishedCount(brandId) {
            return PIPELINES[brandId].published ? PIPELINES[brandId].published.length : 0;
        }

        function initializeCharts() {
            // Content over time chart
            var contentCtx = document.getElementById('contentChart');
            if (contentCtx) {
                ANALYTICS_CHARTS.content = new Chart(contentCtx, {
                    type: 'line',
                    data: {
                        labels: getLast30Days(),
                        datasets: [{
                            label: 'Content Published',
                            data: getContentTimeSeriesData(),
                            borderColor: '#8245ff',
                            backgroundColor: 'rgba(130, 69, 255, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Brand performance chart
            var brandCtx = document.getElementById('brandChart');
            if (brandCtx) {
                var brandData = BRANDS.filter(function(b) { 
                    return EVENT_BRANDS.indexOf(b.id) === -1; 
                }).map(function(b) {
                    return getPublishedCount(b.id);
                });
                
                var brandLabels = BRANDS.filter(function(b) { 
                    return EVENT_BRANDS.indexOf(b.id) === -1; 
                }).map(function(b) { return b.name; });
                
                var brandColors = BRANDS.filter(function(b) { 
                    return EVENT_BRANDS.indexOf(b.id) === -1; 
                }).map(function(b) { return b.accent; });
                
                ANALYTICS_CHARTS.brand = new Chart(brandCtx, {
                    type: 'doughnut',
                    data: {
                        labels: brandLabels,
                        datasets: [{
                            data: brandData,
                            backgroundColor: brandColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function getLast30Days() {
            var dates = [];
            for (var i = 29; i >= 0; i--) {
                var d = new Date();
                d.setDate(d.getDate() - i);
                dates.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            }
            return dates;
        }

        function getContentTimeSeriesData() {
            // Generate sample data - in real implementation, calculate from actual publish dates
            return Array(30).fill(0).map(function() { 
                return Math.floor(Math.random() * 10) + 1; 
            });
        }

        function showAnalytics() {
            // Update navigation
            qsa('.nav-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            var analyticsBtn = qs('.nav-btn[data-id="analytics"]');
            if (analyticsBtn) analyticsBtn.classList.add('active');
            
            // Hide other views
            var overview = qs('#overview');
            if (overview) overview.style.display = 'none';
            
            qsa('.view').forEach(function(v) {
                v.classList.remove('active');
            });
            
            // Show analytics
            var analyticsView = qs('#analytics-view');
            if (analyticsView) {
                analyticsView.classList.add('active');
                
                // Initialize or update charts
                setTimeout(function() {
                    if (!ANALYTICS_CHARTS.content) {
                        initializeCharts();
                    } else {
                        updateAnalytics();
                    }
                }, 100);
            }
        }

        function updateAnalytics() {
            // Update metrics based on date range
            // Update charts
            if (ANALYTICS_CHARTS.content) {
                ANALYTICS_CHARTS.content.update();
            }
            if (ANALYTICS_CHARTS.brand) {
                ANALYTICS_CHARTS.brand.update();
            }
        }
        
        // ---------- Quick Search System ----------
        var QuickSearch = {
            isOpen: false,
            selectedIndex: 0,
            results: [],
            
            init: function() {
                console.log('QuickSearch init called');
                var self = this;
                document.addEventListener('keydown', function(e) {
                    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                        e.preventDefault();
                        self.toggle();
                    }
                });
            },
            
            toggle: function() {
                if (this.isOpen) {
                    this.close();
                } else {
                    this.open();
                }
            },
            
            open: function() {
                var self = this;
                this.isOpen = true;
                this.selectedIndex = 0;
                
                var overlay = el('div', 'quick-search-overlay');
                overlay.onclick = function(e) {
                    if (e.target === overlay) self.close();
                };
                
                var modal = el('div', 'quick-search-modal');
                
                var input = el('input', 'quick-search-input');
                input.type = 'text';
                input.placeholder = 'Search content, jump to brand, or type > for commands...';
                
                var results = el('div', 'quick-search-results');
                
                input.addEventListener('input', function() {
                    self.search(this.value, results);
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        self.selectNext();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        self.selectPrev();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        self.executeSelected();
                    } else if (e.key === 'Escape') {
                        self.close();
                    }
                });
                
                modal.appendChild(input);
                modal.appendChild(results);
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                input.focus();
                
                // Show initial suggestions
                this.showSuggestions(results);
            },
            
            close: function() {
                this.isOpen = false;
                var overlay = qs('.quick-search-overlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    setTimeout(function() { 
                        if (overlay && overlay.parentNode) {
                            overlay.parentNode.removeChild(overlay);
                        }
                    }, 200);
                }
            },
            
            search: function(query, resultsContainer) {
                this.selectedIndex = 0;
                this.results = [];
                
                if (!query) {
                    this.showSuggestions(resultsContainer);
                    return;
                }
                
                // Command mode
                if (query.indexOf('>') === 0) {
                    this.searchCommands(query.slice(1).trim(), resultsContainer);
                    return;
                }
                
                // Search all content
                this.searchContent(query, resultsContainer);
            },
            
            showSuggestions: function(container) {
                var self = this;
                this.results = [
                    { type: 'command', icon: '🚀', title: 'Create new content', action: function() { self.createNewContent(); } },
                    { type: 'command', icon: '📊', title: 'View analytics', action: function() { self.close(); show('analytics'); } },
                    { type: 'command', icon: '🔍', title: 'Search all content', action: function() {} },
                    { type: 'command', icon: '📥', title: 'Export data', action: function() { self.close(); showExportModal(); } }
                ];
                
                // Add brand shortcuts
                BRANDS.forEach(function(brand) {
                    self.results.push({
                        type: 'brand',
                        icon: '🏷️',
                        title: brand.name,
                        meta: brand.desc,
                        brandColor: brand.accent,
                        action: function() { self.close(); show(brand.id); }
                    });
                });
                
                this.renderResults(container);
            },
            
            searchContent: function(query, container) {
                var self = this;
                var lowerQuery = query.toLowerCase();
                
                // Search through all pipeline content
                BRANDS.forEach(function(brand) {
                    var stages = EVENT_BRANDS.indexOf(brand.id) !== -1 ? EVENT_STAGES : EDIT_STAGES;
                    
                    stages.forEach(function(stage) {
                        var items = PIPELINES[brand.id][stage] || [];
                        
                        items.forEach(function(item) {
                            var matchesTitle = item.title.toLowerCase().indexOf(lowerQuery) !== -1;
                            var matchesTags = false;
                            
                            if (item.tags && item.tags.length > 0) {
                                for (var i = 0; i < item.tags.length; i++) {
                                    if (item.tags[i].toLowerCase().indexOf(lowerQuery) !== -1) {
                                        matchesTags = true;
                                        break;
                                    }
                                }
                            }
                            
                            if (matchesTitle || matchesTags) {
                                self.results.push({
                                    type: 'content',
                                    icon: self.getContentIcon(item.title),
                                    title: item.title,
                                    meta: brand.name + ' • ' + stage,
                                    brandColor: brand.accent,
                                    itemId: item.id,
                                    brandId: brand.id,
                                    action: function() {
                                        self.close();
                                        show(brand.id);
                                        // Highlight the item after view loads
                                        setTimeout(function() {
                                            var element = qs('[data-id="' + item.id + '"]');
                                            if (element) {
                                                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                                element.style.animation = 'pulse 2s ease-out';
                                            }
                                        }, 300);
                                    }
                                });
                            }
                        });
                    });
                });
                
                // Search calendar items too
                BRANDS.forEach(function(brand) {
                    if (CALENDAR_DATA[brand.id]) {
                        Object.keys(CALENDAR_DATA[brand.id]).forEach(function(dateStr) {
                            var items = CALENDAR_DATA[brand.id][dateStr] || [];
                            items.forEach(function(item) {
                                if (item.title && item.title.toLowerCase().indexOf(lowerQuery) !== -1) {
                                    self.results.push({
                                        type: 'calendar',
                                        icon: '📅',
                                        title: item.title,
                                        meta: brand.name + ' • Scheduled ' + dateStr,
                                        brandColor: brand.accent,
                                        action: function() {
                                            self.close();
                                            show(brand.id);
                                            toggleView(brand.id, 'calendar');
                                        }
                                    });
                                }
                            });
                        });
                    }
                });
                
                // Show "no results" if empty
                if (this.results.length === 0) {
                    this.results.push({
                        type: 'empty',
                        icon: '🔍',
                        title: 'No results found',
                        meta: 'Try a different search term',
                        action: function() {}
                    });
                }
                
                this.renderResults(container);
            },
            
            searchCommands: function(query, container) {
                var self = this;
                var commands = [
                    { icon: '➕', title: 'New Video', action: function() { self.createNewItem('video'); } },
                    { icon: '➕', title: 'New Article', action: function() { self.createNewItem('article'); } },
                    { icon: '➕', title: 'New Event', action: function() { self.createNewItem('event'); } },
                    { icon: '📊', title: 'Analytics', action: function() { self.close(); show('analytics'); } },
                    { icon: '🔄', title: 'Refresh Data', action: function() { self.close(); loadFromFirebase(); } },
                    { icon: '📥', title: 'Export All Data', action: function() { self.exportAllData(); } },
                    { icon: '🌙', title: 'Toggle Theme', action: function() { self.close(); toggleTheme(); } },
                    { icon: '⌨️', title: 'Keyboard Shortcuts', action: function() { self.close(); showShortcuts(); } }
                ];
                
                this.results = [];
                for (var i = 0; i < commands.length; i++) {
                    if (commands[i].title.toLowerCase().indexOf(query.toLowerCase()) !== -1) {
                        this.results.push(commands[i]);
                    }
                }
                
                this.renderResults(container);
            },
            
            renderResults: function(container) {
                var self = this;
                container.innerHTML = '';
                
                this.results.forEach(function(result, index) {
                    var item = el('div', 'search-result');
                    if (index === self.selectedIndex) {
                        item.classList.add('selected');
                    }
                    
                    var icon = el('span', 'search-result-icon', result.icon);
                    var content = el('div', 'search-result-content');
                    var title = el('div', 'search-result-title', result.title);
                    content.appendChild(title);
                    
                    if (result.meta) {
                        var meta = el('div', 'search-result-meta', result.meta);
                        content.appendChild(meta);
                    }
                    
                    item.appendChild(icon);
                    item.appendChild(content);
                    
                    if (result.brandColor && result.type !== 'empty') {
                        var brand = el('span', 'search-result-brand');
                        brand.style.background = result.brandColor;
                        item.appendChild(brand);
                    }
                    
                    item.onclick = function() {
                        self.selectedIndex = index;
                        self.executeSelected();
                    };
                    
                    container.appendChild(item);
                });
            },
            
            selectNext: function() {
                if (this.selectedIndex < this.results.length - 1) {
                    this.selectedIndex++;
                    this.updateSelection();
                }
            },
            
            selectPrev: function() {
                if (this.selectedIndex > 0) {
                    this.selectedIndex--;
                    this.updateSelection();
                }
            },
            
            updateSelection: function() {
                var self = this;
                qsa('.search-result').forEach(function(el, index) {
                    if (index === self.selectedIndex) {
                        el.classList.add('selected');
                    } else {
                        el.classList.remove('selected');
                    }
                });
            },
            
            executeSelected: function() {
                if (this.results[this.selectedIndex] && this.results[this.selectedIndex].type !== 'empty') {
                    this.results[this.selectedIndex].action();
                }
            },
            
            getContentIcon: function(title) {
                var lower = title.toLowerCase();
                if (lower.indexOf('video') !== -1) return '🎥';
                if (lower.indexOf('article') !== -1 || lower.indexOf('essay') !== -1) return '✏️';
                if (lower.indexOf('newsletter') !== -1) return '📧';
                if (lower.indexOf('podcast') !== -1) return '🎙️';
                if (lower.indexOf('event') !== -1 || lower.indexOf('mixer') !== -1) return '📅';
                if (lower.indexOf('post') !== -1 || lower.indexOf('tweet') !== -1) return '📱';
                return '📄';
            },
            
            createNewContent: function() {
                this.close();
                var brandId = prompt('Enter brand code (knf, fh, mtih, sss, tok, bwitw, indigo):');
                if (brandId && BRANDS.find(function(b) { return b.id === brandId; })) {
                    addItem(brandId);
                }
            },
            
            createNewItem: function(type) {
                this.close();
                if (type === 'event') {
                    addItem('bwitw');
                } else {
                    this.createNewContent();
                }
            },
            
            exportAllData: function() {
                this.close();
                showExportModal();
            }
        };
        
        // ---------- initialize ----------
        console.log('Starting initialization...');
        buildNav();
        buildOverview();
        buildViews();
        buildAnalyticsView();
        QuickSearch.init();
        show('overview');
        loadFromFirebase();
        
        // Check for deadline reminders
        setInterval(() => {
            const reminderWorkflow = WORKFLOWS.find(w => w.id === 'reminder-notifications');
            if (reminderWorkflow && reminderWorkflow.active) {
                checkDeadlines();
            }
        }, 3600000); // Every hour
        
        function checkDeadlines() {
            const tomorrow = addDays(todayISO(), 1);
            BRANDS.forEach(brand => {
                const stages = EVENT_BRANDS.includes(brand.id) ? EVENT_STAGES : EDIT_STAGES;
                stages.forEach(stage => {
                    const items = PIPELINES[brand.id][stage] || [];
                    items.forEach(item => {
                        if (item.scheduledDate === tomorrow && stage !== 'published' && stage !== 'completed') {
                            showNotification('Deadline Tomorrow', item.title + ' is due tomorrow', 'info');
                        }
                    });
                });
            });
        }
        
        // Real-time sync
        BRANDS.forEach(function(brand) {
            // Listen for pipeline changes
            db.collection('empire-pipelines').doc(brand.id)
                .onSnapshot(function(doc) {
                    if (doc.exists && doc.metadata.hasPendingWrites === false) {
                        PIPELINES[brand.id] = doc.data().data || PIPELINES[brand.id];
                        refreshView(brand.id);
                    }
                });
        });
        
        // Welcome message
        setTimeout(() => {
            const hour = new Date().getHours();
            const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
            showNotification(greeting + '!', 'Your content empire awaits ✨', 'info');
        }, 1000);
        
    }); // This closes the DOMContentLoaded event listener
    </script>
</body>
</html>
